---
/**
 * @file Site Footer Component
 * @module SiteFooter
 * @description Renders the main site footer, including contact information,
 * navigation sitemaps, social links, and legal disclaimers.
 * It also handles geo-location checking to display regional privacy links.
 */
 import { getVisitorInfo } from '../utils/locationCheck';

// 1. Fetch geo-location information (Astro Server-Side)
// This determines whether to initially show the "Cookie Settings" link based on user location.
const info = await getVisitorInfo();
const isLocal = info.isLocal; // Assuming 'isLocal' means they are NOT in a privacy-regulated region

// 2. Define static content/data for the footer (better than hardcoding)
// In a real project, this might come from a CMS or a dedicated JSON/TS file.
const footerNavSections = [
  {
    title: 'Worship',
    links: [
      { href: '/worship', text: 'Sunday Services', content: 'sunday_services' },
      { href: '/live', text: 'Watch Online', content: 'watch_online' },
      { href: '/calendar', text: 'Calendar', content: 'calendar' },
      { href: '/giving', text: 'Giving', content: 'giving' },
    ],
  },
  {
    title: 'Community',
    links: [
      { href: '/children-youth', text: 'Children & Youth', content: 'children_youth' },
      { href: '/about', text: 'About Us', content: 'about_us' },
      { href: '/staff', text: 'Staff', content: 'staff' },
      { href: '/weddings', text: 'Weddings', content: 'weddings' },
    ],
  },
  {
    title: 'Resources',
    links: [
      { href: '/blog', text: 'Blog', content: 'blog' },
      { href: '/chimes', text: 'Newsletter', content: 'newsletter' },
      { href: '/videos', text: 'Service Videos', content: 'service_videos' },
      { href: 'https://shelterinastorm.org', text: 'Shelter in a Storm', content: 'shelter_storm', external: true },
    ],
  },
  {
    title: 'Support',
    links: [
      { href: '/report', text: 'Report an Issue', content: 'report_issue' },
      { href: '/terms', text: 'Terms of Service', content: 'terms' },
      { href: '/privacy', text: 'Privacy Policy', content: 'privacy' },
    ],
  },
];

const contactInfo = {
  address: [
    '1560 Bagnell Dam Blvd.',
    'P.O. Box 194',
    'Lake Ozark, MO 65049',
  ],
  phone: '573-365-3366',
  email: 'office@lakeozarkdisciples.org',
};

// Common UTM parameters for footer navigation
const utmParams = 'utm_source=lakeozarkdisciples&utm_medium=footer&utm_campaign=navigation';
---

<footer class="bg-gray-50 border-t border-gray-200" role="contentinfo">
  
  <div class="container mx-auto px-6 py-16">
    <div class="max-w-7xl mx-auto">
      <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-8 mb-12">
        
        <div class="col-span-2 md:col-span-1">
          <div class="mb-6">
            <img 
              src="http://cdn.lakeozarkdisciples.org/media/LOCC-header.png" 
              alt="Lake Ozark Christian Church Logo" 
              class="h-12 rounded-lg"
              width="auto" 
              height="48"
              loading="lazy"
            />
          </div>
          
          <address class="not-italic space-y-3 text-gray-600 text-sm">
            
            <div class="flex items-start gap-3">
              <svg class="w-4 h-4 text-brand mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>
              </svg>
              <div>
                {contactInfo.address.map(line => <p>{line}</p>)}
              </div>
            </div>
            
            <a href={`tel:${contactInfo.phone}`} class="flex items-center gap-3 hover:text-brand transition-colors">
              <svg class="w-4 h-4 text-brand flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"/>
              </svg>
              {contactInfo.phone}
            </a>
            
            <a href={`mailto:${contactInfo.email}`} class="flex items-center gap-3 hover:text-brand transition-colors">
              <svg class="w-4 h-4 text-brand flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
              </svg>
              {contactInfo.email}
            </a>
          </address>
        </div>

        {footerNavSections.map(section => (
          <div>
            <h3 class="font-semibold text-gray-900 mb-4">{section.title}</h3>
            <ul class="space-y-2 text-sm">
              {section.links.map(link => (
                <li class={link.content === 'privacy' ? 'privacy-link-item' : ''}>
                  <a 
                    href={`${link.href}?${utmParams}&utm_content=${link.content}`} 
                    class="text-gray-600 hover:text-brand transition-colors"
                    target={link.external ? '_blank' : undefined}
                    rel={link.external ? 'noopener noreferrer' : undefined}
                  >
                    {link.text}
                  </a>
                </li>
              ))}
              
              {section.title === 'Support' && (
                <li>
                  <button
                    id="privacy-choices-link"
                    onclick="window.showCookieSettings && window.showCookieSettings()"
                    class={`text-gray-600 hover:text-brand transition-colors ${!isLocal ? '' : 'hidden'}`}
                  >
                    Cookie Settings
                  </button>
                </li>
              )}
            </ul>
          </div>
        ))}
        
      </div>

      <div class="flex justify-center gap-6 mb-8">
        
        <a 
          href="https://facebook.com/LakeOzarkChristianChurch?utm_source=lakeozarkdisciples&utm_medium=footer&utm_campaign=social&utm_content=facebook" 
          target="_blank" 
          rel="noopener noreferrer" 
          class="text-gray-400 hover:text-brand transition-colors"
          aria-label="Find us on Facebook (Opens in a new tab)"
        >
          <svg class="h-6 w-6" fill="currentColor" viewBox="0 0 24 24">
            <path fill-rule="evenodd" d="M22 12c0-5.523-4.477-10-10-10S2 6.477 2 12c0 4.991 3.657 9.128 8.438 9.878v-6.987h-2.54V12h2.54V9.797c0-2.506 1.492-3.89 3.777-3.89 1.094 0 2.238.195 2.238.195v2.46h-1.26c-1.243 0-1.63.771-1.63 1.562V12h2.773l-.443 2.89h-2.33v6.988C18.343 21.128 22 16.991 22 12z" clip-rule="evenodd" />
          </svg>
        </a>
        
        <a 
          href="https://youtube.com/@lakeozarkchristianchurch?utm_source=lakeozarkdisciples&utm_medium=footer&utm_campaign=social&utm_content=youtube" 
          target="_blank" 
          rel="noopener noreferrer" 
          class="text-gray-400 hover:text-brand transition-colors"
          aria-label="Watch videos on YouTube (Opens in a new tab)"
        >
          <svg class="h-6 w-6" fill="currentColor" viewBox="0 0 24 24">
            <path fill-rule="evenodd" d="M19.812 5.418c.861.23 1.538.907 1.768 1.768C21.998 8.746 22 12 22 12s0 3.255-.418 4.814a2.504 2.504 0 0 1-1.768 1.768c-1.56.419-7.814.419-7.814.419s-6.255 0-7.814-.419a2.505 2.505 0 0 1-1.768-1.768C2 15.255 2 12 2 12s0-3.255.417-4.814a2.507 2.507 0 0 1 1.768-1.768C5.744 5 11.998 5 11.998 5s6.255 0 7.814.418ZM15.194 12 10 15V9l5.194 3Z" clip-rule="evenodd" />
          </svg>
        </a>
      </div>
    </div>
  </div>

  <div class="border-t border-gray-200 bg-white py-6">
    <div class="container mx-auto px-6">
      <div class="max-w-7xl mx-auto text-center">
        <p class="text-gray-500 text-sm mb-2">
          &copy; {new Date().getFullYear()} <b>Lake Ozark Christian Church, Inc</b>. All rights reserved.
        </p>
        <p class="text-gray-400 text-xs mb-2">
          A registered <strong>501(c)(3) nonprofit organization</strong> (EIN 43-1193150)
        </p>
        <div class="flex items-center justify-center gap-2 text-xs mt-2">
          <span class="text-gray-400">Site by</span>
          <a
            href="https://donorkit.io/home?utm_source=lakeozarkdisciples&utm_medium=footer&utm_campaign=credit&utm_content=donorkit"
            target="_blank"
            rel="noopener noreferrer"
            aria-label="Visit DonorKit, Inc. website (opens in a new tab)"
          >DonorKit, Inc.</a>
        </div>
        <div class="flex items-center justify-center gap-3 text-xs mt-2 text-gray-400">
          <a href="mailto:webmaster@donorkit.io" class="hover:text-brand transition-colors">webmaster@donorkit.io</a>
          <span>•</span>
          <a href="mailto:abuse@donorkit.io" class="hover:text-brand transition-colors">abuse@donorkit.io</a>
          <span>•</span>
          <a href="mailto:postmaster@donorkit.io" class="hover:text-brand transition-colors">postmaster@donorkit.io</a>
        </div>
      </div>
    </div>
  </div>
</footer>

<script>
  /**
   * Checks the user's location via an external endpoint to determine if they are in 
   * a region with strong data privacy laws (like GDPR, CCPA, etc.).
   * If they are, it ensures the "Cookie Settings" link is visible.
   */
  async function checkPrivacyRegionFallback() {
    const privacyLink = document.getElementById('privacy-choices-link');
    if (!privacyLink) return;

    // The link is initially hidden if Astro's server-side check failed or
    // determined the user was not in a regulated region (isLocal was true).
    
    // Check if the link is already visible (meaning Astro decided it should be shown)
    if (!privacyLink.classList.contains('hidden')) {
      return;
    }

    try {
      const controller = new AbortController();
      // Set a short timeout for the check to prevent blocking page load
      const timeoutId = setTimeout(() => controller.abort(), 1500); 
      
      const response = await fetch('https://geo.locc.us/where', { signal: controller.signal });
      clearTimeout(timeoutId); // Clear timeout if fetch succeeds quickly
      
      if (response.ok) {
        const data = await response.json();
        
        // List of relevant privacy flags
        const privacyFlags = ['gdpr', 'ccpa', 'cpa', 'lgpd', 'pipeda', 'appa'];
        const isInPrivacyRegion = privacyFlags.some(flag => data[flag]);

        if (isInPrivacyRegion) {
          // If the client-side check confirms a privacy region, show the link.
          privacyLink.classList.remove('hidden');
          console.log('Privacy link shown via client-side geo-check.');
        }
      }
    } catch (e) {
      // If the fetch fails (e.g., timeout, network error, CORS), 
      // err on the side of caution and show the link as a safety fallback.
      if (privacyLink.classList.contains('hidden')) {
          privacyLink.classList.remove('hidden');
          console.warn('Geo-location check failed or timed out. Showing privacy link as fallback.', e);
      }
    }
  }

  document.addEventListener('DOMContentLoaded', checkPrivacyRegionFallback);
</script>