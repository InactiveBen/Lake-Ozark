---
import Layout from '../layouts/Layout.astro';
import PrayerRequestForm from '../components/PrayerRequestForm.astro';
import SalvationMarquee from '../components/SalvationMarquee';

import { isLocalVisitor } from '../utils/locationCheck';

const isLocal = await isLocalVisitor();

// Toggle this to show/hide the announcement banner
const showAnnouncementBanner = true;
// Banner content - edit these to change the announcement
const bannerText = "Join us for worship every Sunday at 10:30 AM";
const bannerLink = "/worship";
const bannerLinkText = "Learn more â†’";

const welcomeImage = {
  url: "http://cdn.lakeozarkdisciples.org/media/7767E813-185B-48B7-A7C8-A5C919258FEA.jpeg",
  alt: "Church Sanctuary"
};

// Get recent blog posts for featured section
const posts = await Astro.glob('../blogs/*.md');
const recentPosts = posts
  .filter(post => post.frontmatter && post.frontmatter.id)
  .sort((a, b) => (b.frontmatter?.id || 0) - (a.frontmatter?.id || 0))
  .slice(0, 3);

function formatDate(dateStr: string): string {
  try {
    return new Date(dateStr).toLocaleDateString('en-US', {
      year: 'numeric',
      month: 'long',
      day: 'numeric',
    });
  } catch {
    return 'Date unavailable';
  }
}

---

<Layout title="Welcome">
<!-- Hero Section - Clean and Minimalist -->
<section class="relative overflow-hidden bg-white">
  <div class="absolute inset-0">
    <img 
      src={welcomeImage.url} 
      alt={welcomeImage.alt}
      class="w-full h-full object-cover"
    />
    <div class="absolute inset-0 bg-black/40"></div>
  </div>

  <div class="relative container mx-auto px-6 py-32 md:py-40">
    {showAnnouncementBanner && (
    <div class="mb-8">
      <div class="inline-flex items-center gap-3 bg-white/10 backdrop-blur-sm px-6 py-3 rounded-full border border-white/20">
        <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5.882V19.24a1.76 1.76 0 01-3.417.592l-2.147-6.15M18 13a3 3 0 100-6M5.436 13.683A4.001 4.001 0 017 6h1.832c4.1 0 7.625-1.234 9.168-3v14c-1.543-1.766-5.067-3-9.168-3H7a3.988 3.988 0 01-1.564-.317z" />
        </svg>
        <p class="text-white font-medium text-sm">
          <strong>New:</strong> {bannerText}
          <a href={bannerLink} 
             target="_blank" 
             rel="noopener noreferrer"
             class="underline hover:no-underline ml-2">
            {bannerLinkText}
          </a>
        </p>
      </div>
    </div>
    )}

          <div class="max-w-4xl">
        {isLocal ? (
          <>
            <p class="text-xl md:text-2xl text-white/90 mb-4 font-light leading-relaxed">
              There's a place for you here.
            </p>
            <h1 class="text-5xl md:text-7xl font-semibold text-white mb-8 leading-tight tracking-tight">
              Lake Ozark Christian
            </h1>
            <p class="text-lg md:text-xl text-white/80 mb-12 max-w-2xl font-light leading-relaxed">
              A community of faith dedicated to sharing the Gospel of Jesus Christ. All are welcome.
            </p>
            
            <div class="flex flex-col sm:flex-row gap-4">
              <a 
                href="/worship?utm_source=lakeozarkdisciples&utm_medium=homepage&utm_campaign=hero&utm_content=service_times" 
                class="inline-flex items-center justify-center px-8 py-4 bg-brand hover:bg-brand-dark text-white font-medium rounded-lg transition-all duration-300 text-lg"
              >
                Service Times
              </a>
              <a 
                href="https://www.youtube.com/channel/UCUcLKfZo5Su6-ypmt1dkPKA?utm_source=lakeozarkdisciples&utm_medium=homepage&utm_campaign=hero&utm_content=watch_online" 
                target="_blank"
                rel="noopener noreferrer"
                class="inline-flex items-center justify-center px-8 py-4 bg-transparent border-2 border-white text-white hover:bg-white hover:text-gray-900 font-medium rounded-lg transition-all duration-300 text-lg"
              >
                Watch Online
              </a>
            </div>
          </>
        ) : (
          <>
            <p class="text-xl md:text-2xl text-white/90 mb-4 font-light leading-relaxed">
              Welcome to the Lake of the Ozarks
            </p>
            <h1 class="text-5xl md:text-7xl font-semibold text-white mb-8 leading-tight tracking-tight">
              Plan Your Visit to<br />Lake Ozark Christian
            </h1>
            <p class="text-lg md:text-xl text-white/80 mb-12 max-w-2xl font-light leading-relaxed">
              Whether you're here for vacation or just passing through, we'd love to have you join us for worship at the Lake. 
              Located in the heart of Lake Ozark, we offer a welcoming space for visitors and seasonal residents.
            </p>
            
            <div class="flex flex-col sm:flex-row gap-4">
              <a 
                href="/worship?utm_source=lakeozarkdisciples&utm_medium=homepage&utm_campaign=hero&utm_content=visitor_info#visitor-info" 
                class="inline-flex items-center justify-center px-8 py-4 bg-brand hover:bg-brand-dark text-white font-medium rounded-lg transition-all duration-300 text-lg"
              >
                Visitor Information
              </a>
              <a 
                href="https://www.google.com/maps/dir//Lake+Ozark+Christian+Church,+1560+Bagnell+Dam+Blvd,+Lake+Ozark,+MO+65049/@38.1981839,-92.6386717,19z/?utm_source=lakeozarkdisciples&utm_medium=homepage&utm_campaign=hero&utm_content=get_directions"
                target="_blank"
                rel="noopener noreferrer"
                class="inline-flex items-center justify-center px-8 py-4 bg-transparent border-2 border-white text-white hover:bg-white hover:text-gray-900 font-medium rounded-lg transition-all duration-300 text-lg"
              >
                Get Directions
              </a>
            </div>
          </>
        )}
      </div>
  </div>
</section>

<!-- Visit Us Section -->
<section id="visit" class="py-20 bg-white">
  <div class="container mx-auto px-6">
    <div class="max-w-7xl mx-auto">
      <div class="grid lg:grid-cols-2 gap-16 items-center">
        <div>
          <span id="location-greeting" class="inline-block px-4 py-2 bg-brand/10 text-brand text-sm font-medium mb-6">
            You're Invited
          </span>
          <h2 class="text-4xl lg:text-5xl font-light mb-8 text-gray-900 leading-tight">
            Join Us This Sunday
          </h2>
          <div class="space-y-6">
            <p id="distance-message" class="text-lg text-gray-600 leading-relaxed">
              Whether you're new to faith or have been walking with God for years, you'll find a warm welcome here. No perfect people allowed â€” just Christ followers doing life together.
            </p>
            <div class="bg-gray-50 rounded-xl p-6 space-y-4">
              <div class="flex items-start gap-3">
                <svg class="w-6 h-6 text-brand mt-1 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                <div>
                  <h3 class="font-medium text-gray-900">Sundays at 10:30 AM</h3>
                  <p class="text-gray-600">About an hour â€” come as you are, casual dress welcome</p>
                </div>
              </div>
              <div class="flex items-start gap-3">
                <svg class="w-6 h-6 text-brand mt-1 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
                </svg>
                <div>
                  <h3 class="font-medium text-gray-900">1560 Bagnell Dam Blvd</h3>
                  <p class="text-gray-600">Lake Ozark, MO 65049 Â· Free parking available</p>
                </div>
              </div>
             
            </div>
            <div class="flex flex-col sm:flex-row gap-4">
              <a 
                id="directions-link"
                href="https://www.google.com/maps/dir//Lake+Ozark+Christian+Church,+1560+Bagnell+Dam+Blvd,+Lake+Ozark,+MO+65049?utm_source=lakeozarkdisciples&utm_medium=homepage&utm_campaign=visit_section&utm_content=get_directions"
                target="_blank"
                rel="noopener noreferrer"
                class="inline-flex items-center justify-center px-8 py-4 bg-brand hover:bg-brand-dark text-white font-medium rounded-lg transition-all duration-300"
              >
                Get Directions
              </a>
              <a 
                href="https://www.youtube.com/channel/UCUcLKfZo5Su6-ypmt1dkPKA?utm_source=lakeozarkdisciples&utm_medium=homepage&utm_campaign=visit_section&utm_content=watch_online"
                target="_blank"
                rel="noopener noreferrer"
                class="inline-flex items-center justify-center px-8 py-4 bg-gray-900 hover:bg-gray-800 text-white font-medium rounded-lg transition-all duration-300"
              >
                Watch Online
              </a>
            </div>
          </div>
        </div>
        <div class="relative hidden lg:block">
          <div id="mapbox-map" class="w-full h-[600px] rounded-2xl"></div>
        </div>
      </div>
    </div>
  </div>
</section>

<!-- Live Service Countdown -->
<section id="live-service" class="py-20 bg-white">
  <div class="container mx-auto px-6">
    <div class="max-w-7xl mx-auto">
      <div id="countdown-container" class="hidden">
        <div class="grid lg:grid-cols-2 gap-16 items-center">
          <!-- Countdown on LEFT -->
          <div class="relative hidden lg:block">
            <div class="bg-gray-50 rounded-2xl p-8">
              <div class="text-center mb-6">
                <p class="text-sm text-gray-500 uppercase tracking-wide">Countdown to Service</p>
              </div>
              <div class="grid grid-cols-4 gap-4">
                <div class="text-center">
                  <div id="days" class="text-4xl lg:text-5xl font-bold text-brand mb-1">00</div>
                  <div class="text-sm text-gray-600">Days</div>
                </div>
                <div class="text-center">
                  <div id="hours" class="text-4xl lg:text-5xl font-bold text-brand mb-1">00</div>
                  <div class="text-sm text-gray-600">Hours</div>
                </div>
                <div class="text-center">
                  <div id="minutes" class="text-4xl lg:text-5xl font-bold text-brand mb-1">00</div>
                  <div class="text-sm text-gray-600">Minutes</div>
                </div>
                <div class="text-center">
                  <div id="seconds" class="text-4xl lg:text-5xl font-bold text-brand mb-1">00</div>
                  <div class="text-sm text-gray-600">Seconds</div>
                </div>
              </div>
            </div>
          </div>
          <!-- Text on RIGHT -->
          <div>
            <span class="inline-block px-4 py-2 bg-brand/10 text-brand text-sm font-medium mb-6">
              Next Live Service
            </span>
            <h2 id="service-title" class="text-4xl lg:text-5xl font-light mb-8 text-gray-900 leading-tight">
              Loading...
            </h2>
            <div class="space-y-6">
              <p class="text-lg text-gray-600 leading-relaxed">
                Join us online for worship, prayer, and an inspiring message. Our live stream begins every Sunday at 10:30 AM.
              </p>
              <div class="bg-gray-50 rounded-xl p-6 space-y-4">
                <div class="flex items-start gap-3">
                  <svg class="w-6 h-6 text-brand mt-1 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                  </svg>
                  <div>
                    <h3 class="font-medium text-gray-900">Watch from Anywhere</h3>
                    <p class="text-gray-600">Stream live on YouTube or through our website</p>
                  </div>
                </div>
                <div class="flex items-start gap-3">
                  <svg class="w-6 h-6 text-brand mt-1 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
                  </svg>
                  <div>
                    <h3 class="font-medium text-gray-900">Join the Conversation</h3>
                    <p class="text-gray-600">Chat with our community during the live stream</p>
                  </div>
                </div>
              </div>
              <div class="flex flex-col sm:flex-row gap-4">
                <a 
                  id="live-stream-btn"
                  href="/live?utm_source=lakeozarkdisciples&utm_medium=countdown&utm_campaign=button" 
                  target="_blank"
                  rel="noopener noreferrer"
                  class="inline-flex items-center justify-center px-8 py-4 bg-brand hover:bg-brand-dark text-white font-medium rounded-lg transition-all duration-300"
                >
                  Join Live Stream
                </a>
                <a 
                  href="https://www.youtube.com/channel/UCUcLKfZo5Su6-ypmt1dkPKA?utm_source=lakeozarkdisciples&utm_medium=homepage&utm_campaign=live_service&utm_content=watch_past_services"
                  target="_blank"
                  rel="noopener noreferrer"
                  class="inline-flex items-center justify-center px-8 py-4 bg-gray-900 hover:bg-gray-800 text-white font-medium rounded-lg transition-all duration-300"
                >
                  Watch Past Services
                </a>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <div id="countdown-loading" class="py-8 text-center">
        <div class="inline-flex items-center gap-3">
          <div class="animate-spin rounded-full h-8 w-8 border-2 border-brand border-t-transparent"></div>
          <p class="text-lg text-gray-600">Loading next service...</p>
        </div>
      </div>
      
      <div id="countdown-error" class="hidden py-8 text-center">
        <p class="text-gray-600">Unable to load service information</p>
      </div>
    </div>
  </div>
</section>

<!-- After School Program -->
<section id="after-school" class="py-20 bg-white">
  <div class="container mx-auto px-6">
    <div class="max-w-7xl mx-auto">
      <div class="grid lg:grid-cols-2 gap-16 items-center">
        <!-- Image on LEFT -->
        <div class="relative hidden lg:block">
          <img 
            src="http://cdn.lakeozarkdisciples.org/media/8F240771-48E1-4868-9BC6-6AB8256F433F.jpeg"
            alt="Children participating in after-school activities"
            class="w-full h-[600px] object-cover rounded-2xl"
          />
        </div>
        <!-- Text on RIGHT -->
        <div>
{isLocal ? (
            <>
              <span class="inline-block px-4 py-2 bg-brand/10 text-brand text-sm font-medium mb-6">
                Community Program
              </span>
              <h2 class="text-4xl lg:text-5xl font-light mb-8 text-gray-900 leading-tight">
                After-School Program
              </h2>
              <div class="space-y-6">
                <p class="text-lg text-gray-600 leading-relaxed">
                  Give your child a safe, engaging space to grow after school! Our program combines fun activities, homework help, and meaningful connections - all in a nurturing environment.
                </p>
                <div class="bg-gray-50 rounded-xl p-6 space-y-4">
                  <div class="flex items-start gap-3">
                    <svg class="w-6 h-6 text-brand mt-1 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    <div>
                      <h3 class="font-medium text-gray-900">Perfect for Busy Parents</h3>
                      <p class="text-gray-600">Wednesdays 3:30-5:30 PM, giving you time to handle errands or work commitments</p>
                    </div>
                  </div>
                  <div class="flex items-start gap-3">
                    <svg class="w-6 h-6 text-brand mt-1 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"></path>
                    </svg>
                    <div>
                      <h3 class="font-medium text-gray-900">Safe & Supervised</h3>
                      <p class="text-gray-600 group relative">
                        Qualified staff and volunteers ensure a secure, caring environment
                        <span class="tooltip invisible group-hover:visible absolute left-0 bottom-full mb-2 w-64 p-2 bg-gray-900 text-white text-sm rounded-lg shadow-lg">
                          For your child's safety, every staff member and volunteer must pass comprehensive background checks. 
                        </span>
                      </p>
                    </div>
                  </div>
                </div>
                <div class="flex flex-col sm:flex-row gap-4">
                  <a 
                    href="https://docs.google.com/forms/d/e/1FAIpQLSdIri3EaabwsN84Al7Xd7zVnWI7Jzfaoyu6NVkENI6w9FRaeA/viewform?usp=sf_link&utm_source=lakeozarkdisciples&utm_medium=homepage&utm_campaign=after_school&utm_content=reserve_spot"
                    target="_blank"
                    rel="noopener noreferrer" 
                    class="inline-flex items-center justify-center px-8 py-4 bg-brand hover:bg-brand-dark text-white font-medium rounded-lg transition-all duration-300"
                  >
                    Reserve Your Spot
                  </a>
                  <a 
                    href="/children-youth?utm_source=lakeozarkdisciples&utm_medium=homepage&utm_campaign=after_school&utm_content=learn_more" 
                    class="inline-flex items-center justify-center px-8 py-4 bg-gray-900 hover:bg-gray-800 text-white font-medium rounded-lg transition-all duration-300"
                  >
                    Learn More
                  </a>
                </div>
              </div>
            </>
          ) : (
            <>
              <span class="inline-block px-4 py-2 bg-brand/10 text-brand text-sm font-medium mb-6">
                Children's Ministry
              </span>
              <h2 class="text-4xl lg:text-5xl font-light mb-8 text-gray-900 leading-tight">
                Family-Friendly Worship
              </h2>
              <div class="space-y-6">
                <p class="text-lg text-gray-600 leading-relaxed">
                  Visiting with family? We have engaging programs for children of all ages during our services. Your children will experience God's love through age-appropriate activities and teaching.
                </p>
                <div class="bg-gray-50 rounded-xl p-6 space-y-4">
                  <div class="flex items-start gap-3">
                    <svg class="w-6 h-6 text-brand mt-1 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" />
                    </svg>
                    <div>
                      <h3 class="font-medium text-gray-900">Children's Church (Ages 4-13)</h3>
                      <p class="text-gray-600">Available during our 10:30 AM service, featuring interactive Bible lessons, music, and activities</p>
                    </div>
                  </div>
                  <div class="flex items-start gap-3">
                    <svg class="w-6 h-6 text-brand mt-1 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"></path>
                    </svg>
                    <div>
                      <h3 class="font-medium text-gray-900">Nursery Care (Ages 0-3)</h3>
                      <p class="text-gray-600">Available at both services, staffed by caring volunteers who have passed background checks</p>
                    </div>
                  </div>
                </div>
                <div class="flex flex-col sm:flex-row gap-4">
                  <a 
                    href="/children-youth?utm_source=lakeozarkdisciples&utm_medium=homepage&utm_campaign=after_school_visitor&utm_content=what_to_expect#visitor" 
                    class="inline-flex items-center justify-center px-8 py-4 bg-brand hover:bg-brand-dark text-white font-medium rounded-lg transition-all duration-300"
                  >
                    What to Expect
                  </a>
                  <a 
                    href="/worship?utm_source=lakeozarkdisciples&utm_medium=homepage&utm_campaign=after_school_visitor&utm_content=family_faq#family-faq" 
                    class="inline-flex items-center justify-center px-8 py-4 bg-gray-900 hover:bg-gray-800 text-white font-medium rounded-lg transition-all duration-300"
                  >
                    Family FAQ
                  </a>
                </div>
              </div>
            </>
          )}
        </div>
      </div>
    </div>
  </div>
</section>

<!-- Support Our Ministry Section -->
<section id="donate" class="py-20 bg-white">
  <div class="container mx-auto px-6">
    <div class="max-w-7xl mx-auto">
      <div class="grid lg:grid-cols-2 gap-16 items-center">
        <div>
          <span class="inline-block px-4 py-2 bg-brand/10 text-brand text-sm font-medium mb-6">
            Support Our Ministry
          </span>
          <h2 class="text-4xl lg:text-5xl font-light mb-8 text-gray-900 leading-tight">
            Help Us Share God's Love
          </h2>
          <p class="text-lg text-gray-600 mb-8 leading-relaxed">
            Your generous donations help support our worship services, community programs, and outreach efforts. 
            Every gift makes a difference in our mission to serve others.
          </p>
          <div class="flex flex-col sm:flex-row gap-4">
            <a 
              href="/giving?utm_source=lakeozarkdisciples&utm_medium=homepage&utm_campaign=donate_section&utm_content=more_giving_options" 
              class="inline-flex items-center justify-center px-8 py-4 bg-brand hover:bg-brand-dark text-white font-medium rounded-lg transition-all duration-300"
            >
              More Giving Options
            </a>
            <a 
              href="tel:573-365-3366" 
              class="inline-flex items-center justify-center px-8 py-4 bg-gray-900 hover:bg-gray-800 text-white font-medium rounded-lg transition-all duration-300"
            >
              Contact Us
            </a>
          </div>
        </div>
        <div class="relative">
          <div class="bg-gray-50 rounded-2xl p-8">
            <form id="homepage-donation-form" class="space-y-6">
              <!-- Donation Type -->
              <div>
                <div class="grid grid-cols-2 gap-4 mb-4">
                  <label class="relative">
                    <input 
                      type="radio" 
                      name="donationType" 
                      value="one-time" 
                      class="peer sr-only"
                    />
                    <div class="p-3 border-2 border-gray-200 rounded-lg cursor-pointer peer-checked:border-brand peer-checked:bg-brand/5 transition-all duration-300 bg-white">
                      <div class="text-center">
                        <div class="font-medium text-gray-900">One-time</div>
                        <div class="text-sm text-gray-600">Single donation</div>
                      </div>
                    </div>
                  </label>
                  <label class="relative">
                    <input 
                      type="radio" 
                      name="donationType" 
                      value="recurring" 
                      checked 
                      class="peer sr-only"
                    />
                    <div class="p-3 border-2 border-gray-200 rounded-lg cursor-pointer peer-checked:border-brand peer-checked:bg-brand/5 transition-all duration-300 bg-white">
                      <div class="text-center">
                        <div class="font-medium text-gray-900">Recurring</div>
                        <div class="text-sm text-gray-600">Ongoing giving</div>
                      </div>
                    </div>
                  </label>
                </div>
                
                <!-- Recurring Frequency Selection -->
                <div id="homepage-frequency-selection">
                  <label class="block text-sm font-medium text-gray-700 mb-2">Frequency</label>
                  <select 
                    name="frequency" 
                    id="homepage-frequency-select"
                    class="w-full px-3 py-3 border-2 border-gray-200 rounded-lg focus:border-brand focus:outline-none bg-white"
                  >
                    <option value="weekly">Weekly</option>
                    <option value="biweekly">Every Two Weeks</option>
                    <option value="monthly" selected>Monthly</option>
                    <option value="every6months">Every Six Months</option>
                    <option value="yearly">Every Year</option>
                  </select>
                </div>
              </div>

              <!-- Amount Selection -->
              <div>
                <div class="grid grid-cols-3 gap-3 mb-4">
                  <button type="button" class="homepage-amount-btn p-3 border-2 border-gray-200 rounded-lg hover:border-brand transition-all duration-300 bg-white" data-amount="25">
                    <div class="font-medium">$25</div>
                  </button>
                  <button type="button" class="homepage-amount-btn p-3 border-2 border-gray-200 rounded-lg hover:border-brand transition-all duration-300 bg-white" data-amount="50">
                    <div class="font-medium">$50</div>
                  </button>
                  <button type="button" class="homepage-amount-btn p-3 border-2 border-gray-200 rounded-lg hover:border-brand transition-all duration-300 bg-white" data-amount="100">
                    <div class="font-medium">$100</div>
                  </button>
                </div>
                <div class="relative">
                  <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500">$</span>
                  <input 
                    type="number" 
                    id="homepage-custom-amount" 
                    name="amount"
                    min="5" 
                    max="999999"
                    step="0.01"
                    placeholder="Enter custom amount"
                    class="w-full pl-7 pr-3 py-3 border-2 border-gray-200 rounded-lg focus:border-brand focus:outline-none bg-white"
                  />
                </div>
              </div>

              <!-- Cover Processing Fees -->
              <div>
                <label class="flex items-center gap-3 p-3 border-2 border-gray-200 rounded-lg bg-white hover:border-brand transition-all duration-300">
                  <input 
                    type="checkbox" 
                    id="homepage-cover-fees" 
                    name="coverFees"
                    class="w-4 h-4 text-brand focus:ring-brand border-gray-300 rounded"
                  />
                  <div class="flex-1">
                    <div class="font-medium text-gray-900">Cover Processing Fees</div>
                    <div class="text-sm text-gray-600">Add <span id="homepage-fee-amount">$1.75</span> to cover payment processing costs (2.9% + $0.30)</div>
                  </div>
                </label>
              </div>

              <!-- Email -->
              <div>
                <input 
                  type="email" 
                  id="homepage-email" 
                  name="email"
                  required
                  placeholder="your@email.com"
                  class="w-full px-3 py-3 border-2 border-gray-200 rounded-lg focus:border-brand focus:outline-none bg-white"
                />
              </div>

              <!-- Submit Button -->
              <div>
                <button 
                  type="submit"
                  id="homepage-donate-btn"
                  class="w-full bg-brand hover:bg-brand-dark text-white font-medium py-3 px-6 rounded-lg transition-all duration-300 disabled:opacity-50 disabled:cursor-not-allowed"
                >
                  <span id="homepage-btn-text">Give Now</span>
                  <span id="homepage-btn-loading" class="hidden">Processing...</span>
                </button>
              </div>

              <!-- Recurring Donation Warning -->
              <div id="homepage-recurring-warning" class="text-center text-xs text-gray-600 bg-gray-50 rounded-lg p-3 hidden">
                <p class="text-gray-700">You will be charged <span id="homepage-warning-amount" class="font-medium">$50</span> <span id="homepage-warning-frequency" class="font-medium">monthly</span> starting <span id="homepage-warning-date" class="font-medium"></span>. Cancel anytime.</p>
              </div>

              <!-- Security Note -->
              <div class="text-center text-xs text-gray-600 space-y-2">
                <p>Secure donation processed through Stripe by DonorKit, Inc.</p>
                <p>By making a donation you agree to the DonorKit <a href="http://donork.it/privacy" target="_blank" rel="noopener noreferrer" class="text-brand hover:text-brand-dark underline">Privacy Policy</a>, <a href="http://donork.it/terms" target="_blank" rel="noopener noreferrer" class="text-brand hover:text-brand-dark underline">Terms of Service</a>, and <a href="http://donork.it/refund" target="_blank" rel="noopener noreferrer" class="text-brand hover:text-brand-dark underline">Refund Policy</a>.</p>
                <p>
                  <a 
                    href="http://donork.it/locc" 
                    target="_blank" 
                    rel="noopener noreferrer"
                    class="text-brand hover:text-brand-dark underline"
                  >
                    Manage existing subscription â†’
                  </a>
                </p>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>
  
<!-- Prayer Request Section -->
<section id="prayer" class="py-20 bg-white">
  <div class="container mx-auto px-6">
    <div class="max-w-7xl mx-auto">
      <PrayerRequestForm />
    </div>
  </div>
</section>

<!-- Salvation Stories Marquee -->
<section id="salvation-stories" class="py-20 bg-white">
  <SalvationMarquee client:load />
</section>
<!-- Recent Services -->
<section id="services" class="py-20 bg-white">
  <div class="container mx-auto px-6">
    <div class="max-w-7xl mx-auto">
      <div class="text-center mb-16">
        <span class="inline-block px-4 py-2 bg-brand/10 text-brand text-sm font-medium mb-4">
          Watch & Listen
        </span>
        <h2 class="text-4xl lg:text-5xl font-light mb-6 text-gray-900">Recent Services</h2>
        <p class="text-lg text-gray-600 max-w-2xl mx-auto">
          Catch up on our latest worship services and messages
        </p>
      </div>
      
      <div id="video-loading" class="text-center py-16">
        <div class="inline-flex items-center gap-3">
          <div class="animate-spin rounded-full h-8 w-8 border-2 border-brand border-t-transparent"></div>
          <p class="text-lg text-gray-600">Loading recent services...</p>
        </div>
      </div>
      
      <div id="video-error" class="text-center py-16 hidden">
        <div class="bg-red-50 border border-red-200 p-8 max-w-md mx-auto">
          <p class="text-red-700 font-medium">Failed to load recent services</p>
          <p class="text-red-600 text-sm mt-1">Please try again later</p>
        </div>
      </div>
      
      <div id="video-container"></div>
    </div>
  </div>
</section>

<!-- Calendar Section -->
<section id="calendar" class="py-20 bg-white">
  <div class="container mx-auto px-6">
    <div class="max-w-7xl mx-auto">
      <div class="text-center mb-16">
        <span class="inline-block px-4 py-2 bg-brand/10 text-brand text-sm font-medium mb-4">
          Stay Connected
        </span>
        <h2 class="text-4xl lg:text-5xl font-light mb-6 text-gray-900">Upcoming Events</h2>
        <p class="text-lg text-gray-600 max-w-2xl mx-auto">
          Join us for worship, fellowship, and community events
        </p>
      </div>
      
              <div class="bg-white border border-gray-200 overflow-hidden rounded-2xl">
          <div class="p-8">
            <div class="w-full rounded-xl overflow-hidden" style="position: relative; padding-bottom: 75%;">
              <iframe 
                src="https://calendar.google.com/calendar/embed?src=lakeozarkdisciples%40gmail.com&ctz=America%2FChicago" 
                style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: 0;"
                title="Lake Ozark Christian Church Calendar"
                aria-label="Google Calendar showing upcoming church events"
              ></iframe>
            </div>
          </div>
        </div>
    </div>
  </div>
</section>
\

<!-- Toast Container -->
<div id="toast-container" class="fixed top-4 right-4 z-50 space-y-2"></div>

<!-- Video Modal -->
<div id="video-modal" class="hidden fixed inset-0 bg-black bg-opacity-75 z-50 flex items-center justify-center p-4" onclick="closeVideoModal()">
  <div class="bg-white rounded-lg max-w-4xl w-full max-h-[90vh] overflow-hidden" onclick="event.stopPropagation()">
    <div class="flex justify-between items-center p-4 border-b">
      <h3 id="video-modal-title" class="text-lg font-semibold text-gray-900"></h3>
      <button 
        onclick="closeVideoModal()" 
        class="text-gray-400 hover:text-gray-600 transition-colors"
        aria-label="Close video"
      >
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
        </svg>
      </button>
    </div>
    <div class="aspect-video">
      <iframe 
        id="video-iframe"
        class="w-full h-full"
        frameborder="0"
        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
        allowfullscreen
      ></iframe>
    </div>
  </div>
</div>

<link href="https://api.mapbox.com/mapbox-gl-js/v3.3.0/mapbox-gl.css" rel="stylesheet" />
<script src="https://api.mapbox.com/mapbox-gl-js/v3.3.0/mapbox-gl.js"></script>

<script>
  // Initialize Mapbox map and personalized location experience
  document.addEventListener('DOMContentLoaded', async () => {
    const accessToken = 'pk.eyJ1IjoiZG9ub3JraXQiLCJhIjoiY21paDBqZjJwMGM3ZjNjcHNnaWt2Z2l3aiJ9.fXOKheOAlOOIIh2mB6t-mA';
    const churchAddress = '1560 Bagnell Dam Blvd, Lake Ozark, MO 65049';
    // Hardcoded coordinates for church (verified via API - no API call needed)
    const churchCoords: [number, number] = [-92.64159, 38.19839];
    
    const greetingEl = document.getElementById('location-greeting');
    const distanceEl = document.getElementById('distance-message');
    const directionsLink = document.getElementById('directions-link') as HTMLAnchorElement;
    
    // Use hardcoded coordinates (no geocoding API call to save money)
    const coords = churchCoords;
    
    // Initialize map first (shows church only)
    const mapContainer = document.getElementById('mapbox-map');
    let map: any = null;
    
    if (mapContainer && (window as any).mapboxgl) {
      (window as any).mapboxgl.accessToken = accessToken;
      
      map = new (window as any).mapboxgl.Map({
        container: 'mapbox-map',
        style: 'mapbox://styles/mapbox/outdoors-v12',
        center: coords,
        zoom: 15
      });
      
      // Navigation controls (zoom, compass)
      map.addControl(new (window as any).mapboxgl.NavigationControl(), 'top-right');
      
      // Fullscreen control
      map.addControl(new (window as any).mapboxgl.FullscreenControl(), 'top-right');
      
      // Geolocate control (find my location button)
      const geolocateControl = new (window as any).mapboxgl.GeolocateControl({
        positionOptions: { enableHighAccuracy: true },
        trackUserLocation: true,
        showUserHeading: true,
        showAccuracyCircle: true
      });
      map.addControl(geolocateControl, 'top-right');
      
      // Scale bar
      map.addControl(new (window as any).mapboxgl.ScaleControl({ maxWidth: 100 }), 'bottom-left');
      
      // Add church marker immediately
      map.on('load', () => {
        new (window as any).mapboxgl.Marker({ color: '#8B5A2B' })
          .setLngLat(coords)
          .setPopup(new (window as any).mapboxgl.Popup().setHTML('<strong>Lake Ozark Christian Church</strong><br>1560 Bagnell Dam Blvd'))
          .addTo(map);
      });
    }
    
    // Function to show route on map
    async function showRouteOnMap(visitorLng: number, visitorLat: number) {
      if (!map) return;
      
      try {
        const directionsUrl = `https://api.mapbox.com/directions/v5/mapbox/driving/${visitorLng},${visitorLat};${coords[0]},${coords[1]}?geometries=geojson&overview=full&access_token=${accessToken}`;
        const directionsResponse = await fetch(directionsUrl);
        const directionsData = await directionsResponse.json();
        
        if (directionsData.routes && directionsData.routes.length > 0) {
          const route = directionsData.routes[0];
          const routeGeometry = route.geometry;
          
          // Remove existing route if any
          if (map.getSource('route')) {
            map.removeLayer('route');
            map.removeSource('route');
          }
          
          // Add route line
          map.addSource('route', {
            type: 'geojson',
            data: {
              type: 'Feature',
              properties: {},
              geometry: routeGeometry
            }
          });
          
          map.addLayer({
            id: 'route',
            type: 'line',
            source: 'route',
            layout: { 'line-join': 'round', 'line-cap': 'round' },
            paint: { 'line-color': '#8B5A2B', 'line-width': 4, 'line-opacity': 0.8 }
          });
          
          // Add visitor marker
          new (window as any).mapboxgl.Marker({ color: '#3B82F6' })
            .setLngLat([visitorLng, visitorLat])
            .setPopup(new (window as any).mapboxgl.Popup().setHTML('<strong>Your Location</strong>'))
            .addTo(map);
          
          // Fit map to route
          const bounds = new (window as any).mapboxgl.LngLatBounds();
          routeGeometry.coordinates.forEach((coord: number[]) => bounds.extend(coord));
          map.fitBounds(bounds, { padding: 50 });
          
          // Update distance message
          const durationMins = Math.round(route.duration / 60);
          const distanceMiles = (route.distance / 1609.34).toFixed(1);
          if (distanceEl) {
            distanceEl.textContent = `You're about ${distanceMiles} miles away â€” roughly ${durationMins} minutes by car.`;
          }
          
          // Update directions link
          if (directionsLink) {
            directionsLink.href = `https://www.google.com/maps/dir/${visitorLat},${visitorLng}/Lake+Ozark+Christian+Church,+1560+Bagnell+Dam+Blvd,+Lake+Ozark,+MO+65049?utm_source=lakeozarkdisciples&utm_medium=homepage&utm_campaign=visit_section&utm_content=directions_link`;
          }
        }
      } catch (e) {
        console.warn('Could not fetch directions:', e);
      }
    }
    
    // Check localStorage first for stored user location
    // Check both formats: the new JSON format and the old separate lat/lng format
    let userLocation: { lng: number; lat: number; city?: string; source: string } | null = null;
    
    const storedLocation = localStorage.getItem('user-location');
    const storedLat = localStorage.getItem('user-lat');
    const storedLng = localStorage.getItem('user-lng');
    
    // First try the JSON format
    if (storedLocation) {
      try {
        userLocation = JSON.parse(storedLocation);
        // Check if stored location is less than 30 days old (location doesn't change often)
        const storedTime = localStorage.getItem('user-location-time');
        if (storedTime) {
          const age = Date.now() - parseInt(storedTime);
          const thirtyDays = 30 * 24 * 60 * 60 * 1000;
          if (age > thirtyDays) {
            // Location is stale, clear it
            localStorage.removeItem('user-location');
            localStorage.removeItem('user-location-time');
            userLocation = null;
          }
        }
      } catch (e) {
        console.warn('Failed to parse stored location');
        localStorage.removeItem('user-location');
        localStorage.removeItem('user-location-time');
      }
    }
    
    // Fallback to separate lat/lng format (from LocationPermission component)
    if (!userLocation && storedLat && storedLng) {
      userLocation = {
        lng: parseFloat(storedLng),
        lat: parseFloat(storedLat),
        source: 'browser'
      };
    }
    
    // Function to save location to localStorage (persists across sessions)
    function saveLocationToStorage(lng: number, lat: number, city?: string, source: string = 'browser') {
      const locationData = { lng, lat, city, source, timestamp: Date.now() };
      localStorage.setItem('user-location', JSON.stringify(locationData));
      localStorage.setItem('user-location-time', Date.now().toString());
      // Also store in separate format for LocationPermission component compatibility
      localStorage.setItem('user-lat', lat.toString());
      localStorage.setItem('user-lng', lng.toString());
    }
    
    // Function to use stored or new location
    async function useLocation(lng: number, lat: number, city?: string, source: string = 'browser') {
      // Save to localStorage
      saveLocationToStorage(lng, lat, city, source);
      
      // Update greeting based on source and city
      if (greetingEl && distanceEl) {
        if (source === 'browser') {
          greetingEl.textContent = `ðŸ‘‹ Hello, neighbor!`;
          greetingEl.className = `inline-block px-4 py-2 bg-blue-100 text-blue-700 text-sm font-medium mb-6`;
        } else if (source === 'ip' && city) {
          const localCities = ['lake ozark', 'osage beach', 'camdenton', 'eldon', 'versailles', 'laurie', 'sunrise beach', 'gravois mills'];
          const isLocal = localCities.some((c: string) => city.toLowerCase().includes(c));
          
          if (isLocal) {
            greetingEl.textContent = `ðŸ‘‹ Hello, neighbor!`;
            greetingEl.className = `inline-block px-4 py-2 bg-green-100 text-green-700 text-sm font-medium mb-6`;
            distanceEl.textContent = `We're right here in your community. Stop by this Sunday!`;
          } else {
            const cityName = city.split(' ').map((w: string) => w.charAt(0).toUpperCase() + w.slice(1)).join(' ');
            greetingEl.textContent = `Welcome from ${cityName}!`;
            greetingEl.className = `inline-block px-4 py-2 bg-brand/10 text-brand text-sm font-medium mb-6`;
            distanceEl.textContent = `Visiting the Lake? We'd love to have you join us for worship.`;
          }
        } else if (source === 'stored' && city) {
          // Use stored city info for greeting
          const localCities = ['lake ozark', 'osage beach', 'camdenton', 'eldon', 'versailles', 'laurie', 'sunrise beach', 'gravois mills'];
          const isLocal = localCities.some((c: string) => city.toLowerCase().includes(c));
          
          if (isLocal) {
            greetingEl.textContent = `ðŸ‘‹ Hello, neighbor!`;
            greetingEl.className = `inline-block px-4 py-2 bg-green-100 text-green-700 text-sm font-medium mb-6`;
          } else {
            const cityName = city.split(' ').map((w: string) => w.charAt(0).toUpperCase() + w.slice(1)).join(' ');
            greetingEl.textContent = `Welcome from ${cityName}!`;
            greetingEl.className = `inline-block px-4 py-2 bg-brand/10 text-brand text-sm font-medium mb-6`;
          }
        }
      }
      
      // Wait for map to load then show route
      if (map) {
        if (map.loaded()) {
          await showRouteOnMap(lng, lat);
        } else {
          map.on('load', () => showRouteOnMap(lng, lat));
        }
      }
    }
    
    // If we have stored location with actual coordinates, use it (no permission needed!)
    if (userLocation && userLocation.lng && userLocation.lat && userLocation.source === 'browser') {
      console.log('Using stored browser location:', userLocation);
      await useLocation(userLocation.lng, userLocation.lat, userLocation.city, 'stored');
    } else {
      // Only request location if we don't have stored browser location
      // Check if user has already denied permission
      const permissionDenied = localStorage.getItem('location-permission-granted') === 'false';
      
      if (permissionDenied) {
        // User previously denied, fall back to IP location (less accurate but no permission needed)
        console.log('Location permission previously denied, using IP location');
        await fallbackToIPLocation();
      } else if ('geolocation' in navigator) {
        // Try browser geolocation (most accurate - actual coordinates)
        navigator.geolocation.getCurrentPosition(
          // Success - user granted permission
          async (position) => {
            const { longitude, latitude } = position.coords;
            console.log('Got browser location:', { longitude, latitude });
            await useLocation(longitude, latitude, undefined, 'browser');
          },
          // Error or denied - fall back to IP geolocation
          async (error) => {
            console.log('Geolocation denied or failed:', error);
            localStorage.setItem('location-permission-granted', 'false');
            await fallbackToIPLocation();
          },
          { enableHighAccuracy: true, timeout: 5000, maximumAge: 300000 }
        );
      } else {
        // Browser doesn't support geolocation, use IP
        await fallbackToIPLocation();
      }
    }
    
    // Fallback to IP-based geolocation
    async function fallbackToIPLocation() {
      try {
        const geoResponse = await fetch('https://geo.locc.us/where');
        const visitorData = await geoResponse.json();
        
        // Show route if we have coordinates
        if (visitorData && visitorData.latitude && visitorData.longitude) {
          const lng = parseFloat(visitorData.longitude);
          const lat = parseFloat(visitorData.latitude);
          const city = visitorData.city;
          
          // Save to localStorage and use location (greeting will be handled in useLocation)
          await useLocation(lng, lat, city, 'ip');
        }
      } catch (e) {
        console.warn('Could not fetch IP location');
      }
    }
  });

  // Toast notification functions
  function showToast(message: string, type: 'success' | 'error' | 'info' | 'warning' = 'info', duration: number = 5000) {
    const container = document.getElementById('toast-container');
    if (!container) return;

    const toastId = `toast-${Date.now()}`;
    const iconMap = {
      success: `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>`,
      error: `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>`,
      warning: `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.996-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path></svg>`,
      info: `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>`
    };

    const colorMap = {
      success: 'bg-green-50 border-green-200 text-green-800',
      error: 'bg-red-50 border-red-200 text-red-800', 
      warning: 'bg-yellow-50 border-yellow-200 text-yellow-800',
      info: 'bg-blue-50 border-blue-200 text-blue-800'
    };

    const toast = document.createElement('div');
    toast.id = toastId;
    toast.className = `${colorMap[type]} border rounded-lg p-4 shadow-lg max-w-sm toast-enter flex items-center gap-3`;
    toast.innerHTML = `
      <div class="flex-shrink-0">${iconMap[type]}</div>
      <div class="flex-1 text-sm font-medium">${message}</div>
      <button onclick="removeToast('${toastId}')" class="flex-shrink-0 hover:opacity-70 transition-opacity">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
        </svg>
      </button>
    `;

    container.appendChild(toast);

    // Auto remove after duration
    if (duration > 0) {
      setTimeout(() => removeToast(toastId), duration);
    }

    return toastId;
  }

  function removeToast(toastId: string) {
    const toast = document.getElementById(toastId);
    if (!toast) return;

    toast.classList.remove('toast-enter');
    toast.classList.add('toast-exit');
    
    setTimeout(() => {
      if (toast.parentNode) {
        toast.parentNode.removeChild(toast);
      }
    }, 300);
  }

  // Make removeToast globally available
  (window as any).removeToast = removeToast;

  // Live Service Countdown functionality
  let countdownInterval;
  let nextServiceTime = null;
  
  async function fetchNextService() {
    const loadingEl = document.getElementById('countdown-loading');
    const errorEl = document.getElementById('countdown-error');
    const containerEl = document.getElementById('countdown-container');
    
    try {
      const response = await fetch('https://live.locc.us/graphql', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          query: `
            query {
              currentOrganization {
                servicesConnection {
                  services {
                    scheduleTime
                    content {
                      title
                    }
                  }
                }
              }
            }
          `
        })
      });
      
      if (!response.ok) throw new Error('Failed to fetch service data');
      
      const data = await response.json();
      const services = data.data?.currentOrganization?.servicesConnection?.services || [];
      
      // Find the next upcoming service
      const now = new Date();
      
      // Pre-process services with parsed dates for better performance
      const processedServices = services
        .filter(service => service.scheduleTime)
        .map(service => ({
          ...service,
          parsedTime: new Date(service.scheduleTime)
        }))
        .filter(service => service.parsedTime > now)
        .sort((a, b) => a.parsedTime.getTime() - b.parsedTime.getTime());
      
      const upcomingServices = processedServices;
      
      if (upcomingServices.length > 0) {
        const nextService = upcomingServices[0];
        nextServiceTime = nextService.parsedTime; // Use pre-parsed date
        
                 // Service title: If available, use service title. Otherwise, fallback.
         const titleEl = document.getElementById('service-title');
         if (titleEl) {
           // Use the service's title if available, else fallback string
           titleEl.textContent = nextService?.content?.title?.trim()
             ? nextService.content.title
             : 'Late Worship Service';
         }
        // Calculate and display initial countdown values immediately
        updateCountdownDisplay();
        
        // Show countdown and start timer
        if (loadingEl) loadingEl.style.display = 'none';
        if (containerEl) containerEl.classList.remove('hidden');
        
        startCountdown();
        
      } else {
        // No upcoming services
        if (loadingEl) loadingEl.style.display = 'none';
        if (errorEl) {
          errorEl.classList.remove('hidden');
          errorEl.querySelector('p').textContent = 'No upcoming services scheduled';
        }
      }
      
    } catch (error) {
      console.error('Error fetching service data:', error);
      if (loadingEl) loadingEl.style.display = 'none';
      if (errorEl) errorEl.classList.remove('hidden');
    }
  }
  
  function updateCountdownDisplay() {
    if (!nextServiceTime) return;
    
    const now = new Date().getTime();
    const distance = nextServiceTime.getTime() - now;
    
    if (distance < 0) {
      // Service has started or passed
      const containerEl = document.getElementById('countdown-container');
      if (containerEl) {
        containerEl.innerHTML = `
          <span class="inline-block px-4 py-2 bg-red-100 text-red-600 text-sm font-medium mb-4">
            Live Now
          </span>
          <h2 class="text-2xl lg:text-3xl font-light mb-6 text-gray-900">
            Service is Live!
          </h2>
          <a 
            href="/live?utm_source=lakeozarkdisciples&utm_medium=countdown&utm_campaign=button" 
            class="inline-flex items-center justify-center px-8 py-4 bg-red-600 hover:bg-red-700 text-white font-medium rounded-lg transition-all duration-300 text-lg animate-pulse"
          >
            Join Live Stream Now
          </a>
        `;
      }
      return false; // Indicate service has started
    }
    
    // Calculate time units
    const days = Math.floor(distance / (1000 * 60 * 60 * 24));
    const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
    const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
    const seconds = Math.floor((distance % (1000 * 60)) / 1000);
    
    // Update countdown display
    const daysEl = document.getElementById('days');
    const hoursEl = document.getElementById('hours');
    const minutesEl = document.getElementById('minutes');
    const secondsEl = document.getElementById('seconds');
    const liveStreamBtn = document.getElementById('live-stream-btn');
    
    if (daysEl) daysEl.textContent = days.toString().padStart(2, '0');
    if (hoursEl) hoursEl.textContent = hours.toString().padStart(2, '0');
    if (minutesEl) minutesEl.textContent = minutes.toString().padStart(2, '0');
    if (secondsEl) secondsEl.textContent = seconds.toString().padStart(2, '0');
    
    // Button is now always visible in the new layout
    
    return true; // Indicate countdown is active
  }

  function startCountdown() {
    if (!nextServiceTime) return;
    
    countdownInterval = setInterval(() => {
      const isActive = updateCountdownDisplay();
      if (!isActive) {
        // Service has started, clear the interval
        clearInterval(countdownInterval);
      }
    }, 1000);
  }
  
  // Initialize countdown
  fetchNextService();
  
  // Re-fetch service data every 30 minutes
  setInterval(fetchNextService, 30 * 60 * 1000);
  
  let currentVideoPage = 0;
  let allVideos: any[] = [];
  const videosPerPage = 3;

  async function loadVideos() {
    const loadingEl = document.getElementById('video-loading');
    const errorEl = document.getElementById('video-error');
    const containerEl = document.getElementById('video-container');
    
    try {
      const response = await fetch('/api/videos.json?' + new Date().getTime()); // Cache busting
      
      if (!response.ok) {
        const errorText = await response.text();
        console.error('API response error:', errorText);
        throw new Error(`Failed to fetch videos: ${response.status} ${response.statusText}`);
      }
      
      const responseData = await response.json();
      
      // Check if response has error property
      if (responseData.error) {
        throw new Error(responseData.error);
      }
      
      allVideos = Array.isArray(responseData) ? responseData : [];
      
      if (loadingEl) loadingEl.style.display = 'none';
      
      if (allVideos.length > 0) {
        displayVideos();
      } else {
        if (errorEl) {
          errorEl.style.display = 'block';
          errorEl.innerHTML = '<div class="bg-yellow-50 border border-yellow-200 p-8 max-w-md mx-auto"><p class="text-yellow-700 font-medium">No videos available</p><p class="text-yellow-600 text-sm mt-1">Check back later for new content</p></div>';
        }
      }
      
    } catch (error) {
      console.error('Error loading videos:', error);
      if (loadingEl) loadingEl.style.display = 'none';
      if (errorEl) {
        errorEl.style.display = 'block';
        errorEl.innerHTML = `<div class="bg-red-50 border border-red-200 p-8 max-w-md mx-auto"><p class="text-red-700 font-medium">Failed to load recent services</p><p class="text-red-600 text-sm mt-1">${error.message}</p></div>`;
      }
    }
  }

  function displayVideos() {
    const containerEl = document.getElementById('video-container');
    
    if (!containerEl || allVideos.length === 0) return;

    const startIndex = 0;
    const endIndex = Math.min(videosPerPage * (currentVideoPage + 1), allVideos.length);
    const videosToShow = allVideos.slice(startIndex, endIndex);
    
    const videoGridHTML = `
      <div class="space-y-12">
        <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-8" id="video-grid">
          ${videosToShow.map((video) => `
             <div class="video-item bg-white border border-gray-200 overflow-hidden group hover:shadow-lg transition-all duration-300 rounded-xl">
               <button 
                 onclick="openVideoModal('${video.id}', '${video.title.replace(/"/g, '&quot;')}')"
                 class="block w-full text-left"
                 aria-label="Watch ${video.title}"
               >
                 <div class="relative aspect-video overflow-hidden">
                   <img 
                     id="thumbnail-${video.id}"
                     src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='480' height='270' viewBox='0 0 480 270'%3E%3Crect width='480' height='270' fill='%23f3f4f6'/%3E%3Ctext x='240' y='135' text-anchor='middle' dy='0.35em' font-family='Arial, sans-serif' font-size='16' fill='%23666'%3ELoading...%3C/text%3E%3C/svg%3E"
                     alt="Thumbnail for ${video.title}"
                     class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-500"
                     data-video-id="${video.id}"
                     data-video-title="${video.title.replace(/"/g, '&quot;')}"
                   />
                   <div class="absolute inset-0 bg-black/0 group-hover:bg-black/30 transition-all duration-300 flex items-center justify-center">
                     <div class="opacity-0 group-hover:opacity-100 transition-opacity duration-300 bg-white/20 backdrop-blur-sm rounded-full p-4">
                       <svg class="w-12 h-12 text-white" fill="currentColor" viewBox="0 0 24 24">
                         <path d="M8 5v14l11-7z"/>
                       </svg>
                     </div>
                   </div>
                 </div>
                 <div class="p-6">
                   <h3 class="font-semibold text-lg text-gray-900 group-hover:text-brand transition-colors duration-300 leading-tight">${video.title}</h3>
                 </div>
               </button>
             </div>
           `).join('')}
        </div>
        ${endIndex < allVideos.length ? `
          <div class="text-center">
            <button
              id="view-more-btn"
              class="inline-flex items-center justify-center px-8 py-4 bg-brand hover:bg-brand-dark text-white font-medium rounded-lg transition-all duration-300"
            >
              View More Services
            </button>
          </div>
        ` : ''}
      </div>
    `;
    
    containerEl.innerHTML = videoGridHTML;
    setupVideoGrid();
    
    // Generate dynamic thumbnails for videos that need them
    generateDynamicThumbnails(videosToShow);
  }

  function setupVideoGrid() {
    const viewMoreBtn = document.getElementById('view-more-btn');
    
    if (viewMoreBtn) {
      viewMoreBtn.addEventListener('click', () => {
        currentVideoPage++;
        displayVideos();
      });
    }
  }

  // Dynamic thumbnail generation variables
  let thumbnailGenerator;

  // Initialize thumbnail generator
  async function initThumbnailGenerator() {
    thumbnailGenerator = await import('../utils/clientThumbnailGenerator.js');
  }

  // Function to generate dynamic thumbnails for videos
  async function generateDynamicThumbnails(videos) {
    if (!thumbnailGenerator) {
      await initThumbnailGenerator();
    }

    for (const video of videos) {
      const thumbnailEl = document.getElementById(`thumbnail-${video.id}`);
      if (!thumbnailEl || !(thumbnailEl instanceof HTMLImageElement)) continue;

      try {
        // Generate dynamic thumbnail for ALL videos with church background
        const dynamicThumbnail = await thumbnailGenerator.getVideoThumbnail({
          id: video.id,
          title: video.title
        });

        // Make sure we got a valid data URL string, not a Promise
        if (dynamicThumbnail && typeof dynamicThumbnail === 'string' && dynamicThumbnail !== thumbnailEl.src) {
          // Replace placeholder with generated thumbnail immediately
          thumbnailEl.src = dynamicThumbnail;
        }
      } catch (error) {
        console.warn(`Failed to generate thumbnail for ${video.id}:`, error);
      }
    }
  }

  // Preload thumbnails for better performance
  async function preloadAllThumbnails() {
    if (!thumbnailGenerator) {
      await initThumbnailGenerator();
    }
    if (allVideos.length > 0) {
      thumbnailGenerator.preloadThumbnails(allVideos);
    }
  }

  // Clear cache on initial load to force regeneration with new church background
  loadVideos();
  
  document.addEventListener('astro:page-load', () => {
    currentVideoPage = 0;
    allVideos = [];
    loadVideos();
  });

  // Video Modal Functions
  function openVideoModal(videoId: string, videoTitle: string) {
    const modal = document.getElementById('video-modal');
    const iframe = document.getElementById('video-iframe') as HTMLIFrameElement;
    const title = document.getElementById('video-modal-title');
    
    if (modal && iframe && title) {
      title.textContent = videoTitle;
      iframe.src = `https://www.youtube.com/embed/${videoId}?autoplay=1&rel=0`;
      modal.classList.remove('hidden');
      document.body.style.overflow = 'hidden'; // Prevent background scrolling
    }
  }

  function closeVideoModal() {
    const modal = document.getElementById('video-modal');
    const iframe = document.getElementById('video-iframe') as HTMLIFrameElement;
    
    if (modal && iframe) {
      modal.classList.add('hidden');
      iframe.src = ''; // Stop video playback
      document.body.style.overflow = ''; // Restore scrolling
    }
  }

  // Close modal when clicking outside or pressing Escape
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
      closeVideoModal();
    }
  });

  // Make functions globally available
  (window as any).openVideoModal = openVideoModal;
  (window as any).closeVideoModal = closeVideoModal;

  // Homepage donation form functionality
  // Function to calculate processing fee
  function calculateHomepageProcessingFee(amount: number): number {
    return Math.round((amount * 0.029 + 0.30) * 100) / 100;
  }

  // Function to update fee display
  function updateHomepageFeeDisplay() {
    const amountInput = document.getElementById('homepage-custom-amount') as HTMLInputElement;
    const feeAmountSpan = document.getElementById('homepage-fee-amount');
    
    if (amountInput && feeAmountSpan) {
      const amount = parseFloat(amountInput.value) || 50;
      const fee = calculateHomepageProcessingFee(amount);
      feeAmountSpan.textContent = `$${fee.toFixed(2)}`;
    }
  }

  // Function to update recurring warning
  function updateHomepageRecurringWarning() {
    const recurringRadio = document.querySelector('input[name="donationType"][value="recurring"]') as HTMLInputElement;
    const warningDiv = document.getElementById('homepage-recurring-warning');
    const warningAmount = document.getElementById('homepage-warning-amount');
    const warningFrequency = document.getElementById('homepage-warning-frequency');
    const warningDate = document.getElementById('homepage-warning-date');
    const amountInput = document.getElementById('homepage-custom-amount') as HTMLInputElement;
    const frequencySelect = document.getElementById('homepage-frequency-select') as HTMLSelectElement;
    const coverFeesCheckbox = document.getElementById('homepage-cover-fees') as HTMLInputElement;
    
    if (recurringRadio && recurringRadio.checked && warningDiv && warningAmount && warningFrequency && warningDate) {
      // Get current amount
      let amount = parseFloat(amountInput.value) || 50;
      
      // Add processing fee if checked
      if (coverFeesCheckbox && coverFeesCheckbox.checked) {
        amount += calculateHomepageProcessingFee(amount);
      }
      
      warningAmount.textContent = `$${amount.toFixed(2)}`;
      
      // Get frequency text
      const frequency = frequencySelect.value;
      const frequencyMap: Record<string, string> = {
        'weekly': 'weekly',
        'biweekly': 'every two weeks',
        'monthly': 'monthly',
        'every6months': 'every six months',
        'yearly': 'yearly'
      };
      warningFrequency.textContent = frequencyMap[frequency] || 'monthly';
      
      // Use today's date
      const today = new Date();
      const dateStr = today.toLocaleDateString('en-US', { 
        year: 'numeric', 
        month: 'long', 
        day: 'numeric' 
      });
      warningDate.textContent = dateStr;
      
      // Show warning
      warningDiv.classList.remove('hidden');
    } else if (warningDiv) {
      // Hide warning for one-time donations
      warningDiv.classList.add('hidden');
    }
  }

  // Function to toggle frequency selection
  function toggleHomepageFrequencySelection() {
    const recurringRadio = document.querySelector('input[name="donationType"][value="recurring"]') as HTMLInputElement;
    const frequencyDiv = document.getElementById('homepage-frequency-selection');
    
    if (frequencyDiv) {
      if (recurringRadio && recurringRadio.checked) {
        frequencyDiv.classList.remove('hidden');
      } else {
        frequencyDiv.classList.add('hidden');
      }
    }
  }

  // Donation type radio buttons
  document.querySelectorAll('input[name="donationType"]').forEach(radio => {
    radio.addEventListener('change', () => {
      toggleHomepageFrequencySelection();
      updateHomepageRecurringWarning();
    });
  });

  // Frequency selection change
  const homepageFrequencySelect = document.getElementById('homepage-frequency-select');
  if (homepageFrequencySelect) {
    homepageFrequencySelect.addEventListener('change', updateHomepageRecurringWarning);
  }

  // Amount button selection
  document.querySelectorAll('.homepage-amount-btn').forEach(btn => {
    btn.addEventListener('click', function() {
      // Remove selected class from all buttons
      document.querySelectorAll('.homepage-amount-btn').forEach(b => b.classList.remove('selected'));
      // Add selected class to clicked button
      this.classList.add('selected');
      // Set the amount in the input
      const customAmountInput = document.getElementById('homepage-custom-amount') as HTMLInputElement;
      if (customAmountInput && this instanceof HTMLElement && this.dataset.amount) {
        customAmountInput.value = this.dataset.amount;
      }
      // Update fee display and warning
      updateHomepageFeeDisplay();
      updateHomepageRecurringWarning();
    });
  });

  // Custom amount input
  const homepageCustomAmountInput = document.getElementById('homepage-custom-amount');
  if (homepageCustomAmountInput) {
    homepageCustomAmountInput.addEventListener('input', function() {
      // Remove selected class from preset buttons when typing custom amount
      document.querySelectorAll('.homepage-amount-btn').forEach(b => b.classList.remove('selected'));
      // Update fee display and warning
      updateHomepageFeeDisplay();
      updateHomepageRecurringWarning();
    });
  }

  // Cover fees checkbox
  const homepageCoverFeesCheckbox = document.getElementById('homepage-cover-fees');
  if (homepageCoverFeesCheckbox) {
    homepageCoverFeesCheckbox.addEventListener('change', updateHomepageRecurringWarning);
  }

  // Form submission
  const homepageDonationForm = document.getElementById('homepage-donation-form') as HTMLFormElement;
  if (homepageDonationForm) {
    homepageDonationForm.addEventListener('submit', async function(e) {
      e.preventDefault();
      
      const btn = document.getElementById('homepage-donate-btn') as HTMLButtonElement;
      const btnText = document.getElementById('homepage-btn-text');
      const btnLoading = document.getElementById('homepage-btn-loading');
      
      if (!btn || !btnText || !btnLoading) return;
      
      // Get form data
      const formData = new FormData(this);
      const amountValue = formData.get('amount');
      const emailValue = formData.get('email');
      const donationTypeValue = formData.get('donationType');
      const frequencyValue = formData.get('frequency');
      const coverFeesValue = formData.get('coverFees');
      
      // Type-safe conversions
      let amount = parseFloat(amountValue?.toString() || '0');
      const email = emailValue?.toString() || '';
      const donationType = donationTypeValue?.toString() || '';
      const frequency = frequencyValue?.toString() || 'monthly';
      const coverFees = coverFeesValue === 'on';
      
      // Add processing fee if selected
      if (coverFees) {
        amount += calculateHomepageProcessingFee(amount);
      }
      
      // Validate amount
      if (!amount || amount < 5) {
        alert('Please enter a donation amount of at least $5');
        return;
      }
      
      if (amount > 999999) {
        alert('Donation amount cannot exceed $999,999');
        return;
      }
      
      // Validate email
      if (!email || !email.includes('@')) {
        alert('Please enter a valid email address');
        return;
      }
      
              // Show loading state and toast
        btn.disabled = true;
        btnText.classList.add('hidden');
        btnLoading.classList.remove('hidden');
        
        const loadingToastId = showToast(
          'Processing your donation... You\'ll be redirected to complete payment.',
          'info',
          0 // Don't auto-remove
        );
        
        try {
          // Call the donation API
          const response = await fetch('https://api.locc.us/api/v2/donation', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              amount: amount,
              email: email,
              donationType: donationType,
              frequency: frequency,
              coverFees: coverFees
            })
          });
          
          const data = await response.json();
          
          if (data.success && data.url) {
            // Remove loading toast and show success
            removeToast(loadingToastId);
            showToast(
              'Redirecting to secure payment page...',
              'success',
              3000
            );
            
            // Redirect to Stripe checkout
            setTimeout(() => {
              window.location.href = data.url;
            }, 500);
          } else {
            throw new Error(data.message || 'Failed to create donation session');
          }
          
        } catch (error) {
          console.error('Donation error:', error);
          
          // Remove loading toast and show error
          removeToast(loadingToastId);
          showToast(
            'There was an error processing your donation. Please try again or contact us for assistance.',
            'error',
            8000
          );
          
          // Reset button state
          btn.disabled = false;
          btnText.classList.remove('hidden');
          btnLoading.classList.add('hidden');
        }
    });
  }

  // Set default amount for homepage form and initialize displays
  const homepageDefaultBtn = document.querySelector('.homepage-amount-btn[data-amount="50"]') as HTMLElement;
  if (homepageDefaultBtn) {
    homepageDefaultBtn.click();
  }
  
  // Initialize fee display
  updateHomepageFeeDisplay();
  
  // Initialize recurring warning since recurring is default
  updateHomepageRecurringWarning();

  // Clear thumbnail cache to force regeneration with new church background
  function clearThumbnailCache() {
    const keys = Object.keys(sessionStorage);
    keys.forEach(key => {
      if (key.startsWith('thumbnail_')) {
        sessionStorage.removeItem(key);
      }
    });
    console.log('Cleared thumbnail cache for regeneration');
  }
</script>

<style>
  * {
    font-family: 'Albert Sans', system-ui, sans-serif;
  }
  
  h1, h2, h3, h4, h5, h6 {
    font-family: 'Albert Sans', system-ui, sans-serif;
  }

  /* Smooth scrolling for the entire page */
  html {
    scroll-behavior: smooth;
  }

  /* Ensure sections are properly centered when navigated to */
  section[id] {
    scroll-margin-top: 2rem;
  }

  /* For mobile devices, add more top margin */
  @media (max-width: 768px) {
    section[id] {
      scroll-margin-top: 1rem;
    }
  }

  .homepage-amount-btn.selected {
    border-color: #8B5A2B;
    background-color: rgba(139, 90, 43, 0.05);
  }

  .tooltip {
    z-index: 50;
    transform: translateX(-50%);
    left: 50%;
  }

  .tooltip::after {
    content: '';
    position: absolute;
    top: 100%;
    left: 50%;
    margin-left: -5px;
    border-width: 5px;
    border-style: solid;
    border-color: #1f2937 transparent transparent transparent;
  }

  /* Toast animations */
  @keyframes slideInFromRight {
    from {
      transform: translateX(100%);
      opacity: 0;
    }
    to {
      transform: translateX(0);
      opacity: 1;
    }
  }

  @keyframes slideOutToRight {
    from {
      transform: translateX(0);
      opacity: 1;
    }
    to {
      transform: translateX(100%);
      opacity: 0;
    }
  }

  .toast-enter {
    animation: slideInFromRight 0.3s ease-out;
  }

  .toast-exit {
    animation: slideOutToRight 0.3s ease-in;
  }
</style>
</Layout>
