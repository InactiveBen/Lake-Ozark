---
import Layout from '../layouts/Layout.astro';
import PrayerRequestForm from '../components/PrayerRequestForm.astro';
import SalvationMarquee from '../components/SalvationMarquee';
import DonationForm from '../components/DonationForm.astro';

import { isLocalVisitor } from '../utils/locationCheck';

const isLocal = await isLocalVisitor();

// Toggle this to show/hide the announcement banner
const showAnnouncementBanner = true;
// Banner content - edit these to change the announcement
const bannerText = "Join us for worship every Sunday at 10:30 AM";
const bannerLink = "/worship";
const bannerLinkText = "Learn more â†’";

const welcomeImage = {
  url: "https://usercontent.donorkit.io/clients/LOCC/7767E813-185B-48B7-A7C8-A5C919258FEA%20(1).jpeg",
  alt: "Church Sanctuary"
};

// After-school program image for preloading
const afterSchoolImage = "https://usercontent.donorkit.io/clients/LOCC/8F240771-48E1-4868-9BC6-6AB8256F433F.jpeg";

// Get recent blog posts for featured section
const postsGlob = import.meta.glob('../blogs/*.md', { eager: true });
const posts = Object.values(postsGlob) as any[];
const recentPosts = posts
  .filter(post => post.frontmatter && post.frontmatter.id)
  .sort((a, b) => (b.frontmatter?.id || 0) - (a.frontmatter?.id || 0))
  .slice(0, 3);

function formatDate(dateStr: string): string {
  try {
    return new Date(dateStr).toLocaleDateString('en-US', {
      year: 'numeric',
      month: 'long',
      day: 'numeric',
    });
  } catch {
    return 'Date unavailable';
  }
}

---

<Layout title="Welcome">
<!-- Preload critical above-the-fold images for faster LCP -->
<link rel="preload" href={welcomeImage.url} as="image" fetchpriority="high" />

<!-- Typed.js for hero text animation -->
<script src="https://unpkg.com/typed.js@2.1.0/dist/typed.umd.js"></script>


<!-- Hero Section - Clean and Minimalist -->
<section id="hero-section" class="relative overflow-hidden bg-white hero-section">
  <div class="absolute inset-0">
    <img 
      src={welcomeImage.url} 
      alt={welcomeImage.alt}
      class="w-full h-full object-cover"
      fetchpriority="high"
      loading="eager"
      decoding="async"
    />
    <div class="absolute inset-0 bg-black/40"></div>
    <!-- Bottom fade to white (mobile only) -->
    <div class="absolute bottom-0 left-0 right-0 h-24 bg-gradient-to-t from-white to-transparent md:hidden"></div>
  </div>

  <div class="relative container mx-auto px-6 py-32 md:py-40">
    {showAnnouncementBanner && (
    <div class="mb-8">
      <div class="inline-flex items-center gap-3 bg-white/10 backdrop-blur-sm px-6 py-3 rounded-full border border-white/20">
        <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5.882V19.24a1.76 1.76 0 01-3.417.592l-2.147-6.15M18 13a3 3 0 100-6M5.436 13.683A4.001 4.001 0 017 6h1.832c4.1 0 7.625-1.234 9.168-3v14c-1.543-1.766-5.067-3-9.168-3H7a3.988 3.988 0 01-1.564-.317z" />
        </svg>
        <p class="text-white font-medium text-sm">
          {bannerText}
          <a href={bannerLink} 
             class="underline hover:no-underline ml-2">
            {bannerLinkText}
          </a>
        </p>
      </div>
    </div>
    )}

          <div class="max-w-4xl">
        {isLocal ? (
          <>
            <p class="text-xl md:text-2xl text-white/90 mb-4 font-light leading-relaxed h-8">
              <span id="typed-local"></span>
            </p>
            <h1 class="text-5xl md:text-7xl font-semibold text-white mb-8 leading-tight tracking-tight">
              Lake Ozark Christian
            </h1>
            <p class="text-lg md:text-xl text-white/80 mb-12 max-w-2xl font-light leading-relaxed">
              A community of faith dedicated to sharing the Gospel of Jesus Christ. All are welcome.
            </p>
            
            <div class="flex flex-col sm:flex-row gap-4">
              <a 
                href="/worship?utm_source=lakeozarkdisciples&utm_medium=homepage&utm_campaign=hero&utm_content=service_times" 
                class="inline-flex items-center justify-center px-8 py-4 bg-brand hover:bg-brand-dark text-white font-medium rounded-lg transition-all duration-300 text-lg"
              >
                Service Times
              </a>
              <a 
                href="https://www.youtube.com/channel/UCUcLKfZo5Su6-ypmt1dkPKA?utm_source=lakeozarkdisciples&utm_medium=homepage&utm_campaign=hero&utm_content=watch_online" 
                target="_blank"
                rel="noopener noreferrer"
                class="inline-flex items-center justify-center px-8 py-4 bg-transparent border-2 border-white text-white hover:bg-white hover:text-gray-900 font-medium rounded-lg transition-all duration-300 text-lg"
              >
                Watch Online
              </a>
            </div>
          </>
        ) : (
          <>
            <p class="text-xl md:text-2xl text-white/90 mb-4 font-light leading-relaxed h-8">
              <span id="typed-visitor"></span>
            </p>
            <h1 class="text-5xl md:text-7xl font-semibold text-white mb-8 leading-tight tracking-tight">
              Plan Your Visit to<br />Lake Ozark Christian
            </h1>
            <p class="text-lg md:text-xl text-white/80 mb-12 max-w-2xl font-light leading-relaxed">
              Whether you're here for vacation or just passing through, we'd love to have you join us for worship at the Lake. 
              Located in the heart of Lake Ozark, we offer a welcoming space for visitors and seasonal residents.
            </p>
            
            <div class="flex flex-col sm:flex-row gap-4">
              <a 
                href="/worship?utm_source=lakeozarkdisciples&utm_medium=homepage&utm_campaign=hero&utm_content=visitor_info#visitor-info" 
                class="inline-flex items-center justify-center px-8 py-4 bg-brand hover:bg-brand-dark text-white font-medium rounded-lg transition-all duration-300 text-lg"
              >
                Visitor Information
              </a>
              <a 
                href="https://www.google.com/maps/dir//Lake+Ozark+Christian+Church,+1560+Bagnell+Dam+Blvd,+Lake+Ozark,+MO+65049/@38.1981839,-92.6386717,19z/?utm_source=lakeozarkdisciples&utm_medium=homepage&utm_campaign=hero&utm_content=get_directions"
                target="_blank"
                rel="noopener noreferrer"
                class="inline-flex items-center justify-center px-8 py-4 bg-transparent border-2 border-white text-white hover:bg-white hover:text-gray-900 font-medium rounded-lg transition-all duration-300 text-lg"
              >
                Get Directions
              </a>
            </div>
          </>
        )}
      </div>
  </div>
</section>

<!-- Visit Us Section -->
<section id="visit" class="py-20 bg-gray-50">
  <div class="container mx-auto px-6">
    <div class="max-w-7xl mx-auto">
      <div class="grid lg:grid-cols-2 gap-12 items-start">
        <!-- Content on LEFT -->
        <div class="lg:py-4">
          <p id="location-greeting" class="text-sm font-semibold text-brand uppercase tracking-wider mb-4">
            Visit Us
          </p>
          <h2 class="text-3xl lg:text-4xl font-semibold text-gray-900 mb-6">
            Join Us This Sunday
          </h2>
          <p id="distance-message" class="text-gray-600 mb-8 leading-relaxed">
            Whether you're new to faith or have been walking with God for years, you'll find a warm welcome here. 
            No perfect people allowed â€” just Christ followers doing life together.
          </p>
          
          <div class="space-y-4 mb-8">
            <div class="flex items-start gap-3">
              <div class="w-8 h-8 rounded-lg bg-brand/10 flex items-center justify-center flex-shrink-0">
                <svg class="w-4 h-4 text-brand" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>
              </div>
              <div>
                <p class="font-medium text-gray-900">Sunday Worship at 10:30 AM</p>
                <p class="text-sm text-gray-500">About an hour Â· Casual dress welcome</p>
              </div>
            </div>
            <div class="flex items-start gap-3">
              <div class="w-8 h-8 rounded-lg bg-brand/10 flex items-center justify-center flex-shrink-0">
                <svg class="w-4 h-4 text-brand" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>
                </svg>
              </div>
              <div>
                <p class="font-medium text-gray-900">1560 Bagnell Dam Blvd</p>
                <p class="text-sm text-gray-500">Lake Ozark, MO 65049</p>
              </div>
            </div>
            <div class="flex items-start gap-3">
              <div class="w-8 h-8 rounded-lg bg-brand/10 flex items-center justify-center flex-shrink-0">
                <svg class="w-4 h-4 text-brand" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4"/>
                </svg>
              </div>
              <div>
                <p class="font-medium text-gray-900">Free parking available</p>
                <p class="text-sm text-gray-500">Accessible entrance on south side</p>
              </div>
            </div>
          </div>
          
          <div class="flex flex-col sm:flex-row gap-3">
            <a 
              id="directions-link"
              href="https://www.google.com/maps/dir//Lake+Ozark+Christian+Church,+1560+Bagnell+Dam+Blvd,+Lake+Ozark,+MO+65049?utm_source=lakeozarkdisciples&utm_medium=homepage&utm_campaign=visit_section&utm_content=get_directions"
              target="_blank"
              rel="noopener noreferrer"
              class="inline-flex items-center justify-center px-6 py-3 bg-brand hover:bg-brand-dark text-white font-medium rounded transition-colors"
            >
              Get Directions
            </a>
            <a 
              href="https://www.youtube.com/channel/UCUcLKfZo5Su6-ypmt1dkPKA?utm_source=lakeozarkdisciples&utm_medium=homepage&utm_campaign=visit_section&utm_content=watch_online"
              target="_blank"
              rel="noopener noreferrer"
              class="inline-flex items-center justify-center px-6 py-3 border border-gray-300 bg-white hover:bg-gray-50 text-gray-700 font-medium rounded transition-colors"
            >
              Watch Online
            </a>
          </div>
        </div>
        <!-- Map on RIGHT -->
        <div class="relative">
          <div id="mapbox-map" class="w-full h-[400px] lg:h-[500px] rounded-lg border border-gray-200"></div>
        </div>
      </div>
    </div>
  </div>
</section>

<!-- Flip Clock CSS -->
<link href="https://unpkg.com/@pqina/flip/dist/flip.min.css" rel="stylesheet">

<!-- Live Service Countdown -->
<section id="live-service" class="py-20 bg-white border-t border-gray-100">
  <div class="container mx-auto px-6">
    <div class="max-w-7xl mx-auto">
      <div id="countdown-container" class="hidden">
        <div class="grid lg:grid-cols-2 gap-12 items-start">
          <!-- Countdown on LEFT -->
          <div class="relative">
            <div class="bg-gray-50 border border-gray-200 rounded-lg p-8">
              <p class="text-xs font-semibold text-gray-500 uppercase tracking-wider text-center mb-6">Time Until Service</p>
              <div 
                class="tick flip-clock-container"
                data-did-init="handleFlipClockInit"
                aria-label="Countdown timer"
              >
                <div data-repeat="true" data-layout="horizontal fit" data-transform="preset(d, h, m, s) -> delay" aria-hidden="true">
                  <div class="tick-group">
                    <div data-key="value" data-repeat="true" data-transform="pad(00) -> split -> delay">
                      <span data-view="flip"></span>
                    </div>
                    <span data-key="label" data-view="text" class="tick-label"></span>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <!-- Content on RIGHT -->
          <div class="lg:py-4">
            <p class="text-sm font-semibold text-brand uppercase tracking-wider mb-4">Live Stream</p>
            <h2 id="service-title" class="text-3xl lg:text-4xl font-semibold text-gray-900 mb-6">
              Loading...
            </h2>
            <p class="text-gray-600 mb-8 leading-relaxed">
              Join us online for worship, prayer, and an inspiring message. Stream live every Sunday at 10:30 AM Central.
            </p>
            
            <div class="space-y-4 mb-8">
              <div class="flex items-start gap-3">
                <div class="w-8 h-8 rounded-lg bg-brand/10 flex items-center justify-center flex-shrink-0">
                  <svg class="w-4 h-4 text-brand" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"/>
                  </svg>
                </div>
                <div>
                  <p class="font-medium text-gray-900">Watch from anywhere</p>
                  <p class="text-sm text-gray-500">Stream on YouTube or our website</p>
                </div>
              </div>
              <div class="flex items-start gap-3">
                <div class="w-8 h-8 rounded-lg bg-brand/10 flex items-center justify-center flex-shrink-0">
                  <svg class="w-4 h-4 text-brand" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>
                  </svg>
                </div>
                <div>
                  <p class="font-medium text-gray-900">Live chat available</p>
                  <p class="text-sm text-gray-500">Connect with our community in real time</p>
                </div>
              </div>
              <div class="flex items-start gap-3">
                <div class="w-8 h-8 rounded-lg bg-brand/10 flex items-center justify-center flex-shrink-0">
                  <svg class="w-4 h-4 text-brand" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                  </svg>
                </div>
                <div>
                  <p class="font-medium text-gray-900">On-demand replays</p>
                  <p class="text-sm text-gray-500">Missed a service? Watch anytime on YouTube</p>
                </div>
              </div>
            </div>
            
            <div class="flex flex-col sm:flex-row gap-3">
              <a 
                id="live-stream-btn"
                href="/live?utm_source=lakeozarkdisciples&utm_medium=countdown&utm_campaign=button" 
                target="_blank"
                rel="noopener noreferrer"
                class="inline-flex items-center justify-center px-6 py-3 bg-brand hover:bg-brand-dark text-white font-medium rounded transition-colors"
              >
                Join Live Stream
              </a>
              <a 
                href="https://www.youtube.com/channel/UCUcLKfZo5Su6-ypmt1dkPKA?utm_source=lakeozarkdisciples&utm_medium=homepage&utm_campaign=live_service&utm_content=watch_past_services"
                target="_blank"
                rel="noopener noreferrer"
                class="inline-flex items-center justify-center px-6 py-3 border border-gray-300 bg-white hover:bg-gray-50 text-gray-700 font-medium rounded transition-colors"
              >
                Past Services
              </a>
            </div>
          </div>
        </div>
      </div>
      
      <div id="countdown-loading" class="py-12 text-center">
        <div class="inline-flex items-center gap-3">
          <div class="animate-spin rounded-full h-6 w-6 border-2 border-brand border-t-transparent"></div>
          <p class="text-gray-500">Loading service information...</p>
        </div>
      </div>
      
      <div id="countdown-error" class="hidden py-12 text-center">
        <p class="text-gray-500">Unable to load service information. Please try again later.</p>
      </div>
    </div>
  </div>
</section>

<!-- Flip Clock JS -->
<script src="https://unpkg.com/@pqina/flip/dist/flip.min.js"></script>

<!-- After School Program -->
<section id="after-school" class="py-20 bg-gray-50">
  <div class="container mx-auto px-6">
    <div class="max-w-7xl mx-auto">
      <div class="grid lg:grid-cols-2 gap-12 items-start">
        <!-- Image on LEFT -->
        <div class="relative">
          <img 
            src="https://usercontent.donorkit.io/clients/LOCC/8F240771-48E1-4868-9BC6-6AB8256F433F.jpeg"
            alt="Children participating in after-school activities"
            class="w-full h-[500px] object-cover rounded-lg"
            loading="lazy"
            decoding="async"
          />
        </div>
        <!-- Content on RIGHT -->
        <div class="lg:py-4">
{isLocal ? (
            <>
              <p class="text-sm font-semibold text-brand uppercase tracking-wider mb-4">Community Program</p>
              <h2 class="text-3xl lg:text-4xl font-semibold text-gray-900 mb-6">
                After-School Program
              </h2>
              <p class="text-gray-600 mb-8 leading-relaxed">
                A safe, supervised environment where children can learn, play, and grow. Our program provides 
                homework help, engaging activities, and meaningful connections in a nurturing Christian setting.
              </p>
              
              <div class="space-y-4 mb-8">
                <div class="flex items-start gap-3">
                  <div class="w-8 h-8 rounded-lg bg-brand/10 flex items-center justify-center flex-shrink-0">
                    <svg class="w-4 h-4 text-brand" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                  </div>
                  <div>
                    <p class="font-medium text-gray-900">Wednesdays, 3:30 â€“ 5:30 PM</p>
                    <p class="text-sm text-gray-500">During the school year</p>
                  </div>
                </div>
                <div class="flex items-start gap-3">
                  <div class="w-8 h-8 rounded-lg bg-brand/10 flex items-center justify-center flex-shrink-0">
                    <svg class="w-4 h-4 text-brand" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/>
                    </svg>
                  </div>
                  <div>
                    <p class="font-medium text-gray-900">Background-checked staff</p>
                    <p class="text-sm text-gray-500">All volunteers complete comprehensive screening</p>
                  </div>
                </div>
                <div class="flex items-start gap-3">
                  <div class="w-8 h-8 rounded-lg bg-brand/10 flex items-center justify-center flex-shrink-0">
                    <svg class="w-4 h-4 text-brand" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                  </div>
                  <div>
                    <p class="font-medium text-gray-900">Free of charge</p>
                    <p class="text-sm text-gray-500">Open to all families in the community</p>
                  </div>
                </div>
              </div>
              
              <div class="flex flex-col sm:flex-row gap-3">
                <a 
                  href="https://docs.google.com/forms/d/e/1FAIpQLSdIri3EaabwsN84Al7Xd7zVnWI7Jzfaoyu6NVkENI6w9FRaeA/viewform?usp=sf_link&utm_source=lakeozarkdisciples&utm_medium=homepage&utm_campaign=after_school&utm_content=reserve_spot"
                  target="_blank"
                  rel="noopener noreferrer" 
                  class="inline-flex items-center justify-center px-6 py-3 bg-brand hover:bg-brand-dark text-white font-medium rounded transition-colors"
                >
                  Register Your Child
                </a>
                <a 
                  href="/children-youth?utm_source=lakeozarkdisciples&utm_medium=homepage&utm_campaign=after_school&utm_content=learn_more" 
                  class="inline-flex items-center justify-center px-6 py-3 border border-gray-300 bg-white hover:bg-gray-50 text-gray-700 font-medium rounded transition-colors"
                >
                  Program Details
                </a>
              </div>
            </>
          ) : (
            <>
              <p class="text-sm font-semibold text-brand uppercase tracking-wider mb-4">Children's Ministry</p>
              <h2 class="text-3xl lg:text-4xl font-semibold text-gray-900 mb-6">
                Family-Friendly Worship
              </h2>
              <p class="text-gray-600 mb-8 leading-relaxed">
                Visiting with family? We offer engaging, age-appropriate programs for children during our services. 
                Your kids will learn about God's love while you enjoy the worship experience.
              </p>
              
              <div class="space-y-4 mb-8">
                <div class="flex items-start gap-3">
                  <div class="w-8 h-8 rounded-lg bg-brand/10 flex items-center justify-center flex-shrink-0">
                    <svg class="w-4 h-4 text-brand" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"/>
                    </svg>
                  </div>
                  <div>
                    <p class="font-medium text-gray-900">Children's Church (Ages 4â€“13)</p>
                    <p class="text-sm text-gray-500">During 10:30 AM service â€“ Bible lessons, music & activities</p>
                  </div>
                </div>
                <div class="flex items-start gap-3">
                  <div class="w-8 h-8 rounded-lg bg-brand/10 flex items-center justify-center flex-shrink-0">
                    <svg class="w-4 h-4 text-brand" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"/>
                    </svg>
                  </div>
                  <div>
                    <p class="font-medium text-gray-900">Nursery Care (Ages 0â€“3)</p>
                    <p class="text-sm text-gray-500">Available at both services with trained caregivers</p>
                  </div>
                </div>
                <div class="flex items-start gap-3">
                  <div class="w-8 h-8 rounded-lg bg-brand/10 flex items-center justify-center flex-shrink-0">
                    <svg class="w-4 h-4 text-brand" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/>
                    </svg>
                  </div>
                  <div>
                    <p class="font-medium text-gray-900">Background-checked volunteers</p>
                    <p class="text-sm text-gray-500">Your child's safety is our priority</p>
                  </div>
                </div>
              </div>
              
              <div class="flex flex-col sm:flex-row gap-3">
                <a 
                  href="/children-youth?utm_source=lakeozarkdisciples&utm_medium=homepage&utm_campaign=after_school_visitor&utm_content=what_to_expect#visitor" 
                  class="inline-flex items-center justify-center px-6 py-3 bg-brand hover:bg-brand-dark text-white font-medium rounded transition-colors"
                >
                  What to Expect
                </a>
                <a 
                  href="/worship?utm_source=lakeozarkdisciples&utm_medium=homepage&utm_campaign=after_school_visitor&utm_content=family_faq#family-faq" 
                  class="inline-flex items-center justify-center px-6 py-3 border border-gray-300 bg-white hover:bg-gray-50 text-gray-700 font-medium rounded transition-colors"
                >
                  Family FAQ
                </a>
              </div>
            </>
          )}
        </div>
      </div>
    </div>
  </div>
</section>

<!-- Support Our Ministry Section -->
<section id="donate" class="py-20 bg-white">
  <div class="container mx-auto px-6">
    <div class="max-w-7xl mx-auto">
      <div class="grid lg:grid-cols-2 gap-16 items-start">
        <!-- Left Column - Content -->
        <div class="lg:sticky lg:top-8">
          <p class="text-sm font-semibold text-brand uppercase tracking-wider mb-4">Support Our Ministry</p>
          <h2 class="text-3xl lg:text-4xl font-semibold text-gray-900 mb-6">
            Partner with us in sharing God's love
          </h2>
          <p class="text-gray-600 mb-8 leading-relaxed">
            Your tax-deductible donation supports our worship services, community outreach programs, 
            and mission to serve families across the Lake of the Ozarks region.
          </p>
          
          <div class="space-y-4 mb-8">
            <div class="flex items-start gap-3">
              <div class="w-8 h-8 rounded-lg bg-brand/10 flex items-center justify-center flex-shrink-0">
                <svg class="w-4 h-4 text-brand" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 14l6-6m-5.5.5h.01m4.99 5h.01M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16l3.5-2 3.5 2 3.5-2 3.5 2zM10 8.5a.5.5 0 11-1 0 .5.5 0 011 0zm5 5a.5.5 0 11-1 0 .5.5 0 011 0z"/>
                </svg>
              </div>
              <p class="text-gray-600">100% tax-deductible contribution</p>
            </div>
            <div class="flex items-start gap-3">
              <div class="w-8 h-8 rounded-lg bg-brand/10 flex items-center justify-center flex-shrink-0">
                <svg class="w-4 h-4 text-brand" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/>
                </svg>
              </div>
              <p class="text-gray-600">Secure processing via Stripe</p>
            </div>
            <div class="flex items-start gap-3">
              <div class="w-8 h-8 rounded-lg bg-brand/10 flex items-center justify-center flex-shrink-0">
                <svg class="w-4 h-4 text-brand" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                </svg>
              </div>
              <p class="text-gray-600">Cancel recurring gifts anytime</p>
            </div>
          </div>
          
          <div class="pt-6 border-t border-gray-200">
            <p class="text-sm text-gray-500 mb-4">Other ways to give:</p>
            <div class="flex gap-3">
              <a href="/giving" class="text-sm font-medium text-brand hover:text-brand-dark">
                View all options â†’
              </a>
              <span class="text-gray-300">|</span>
              <a href="tel:573-365-3366" class="text-sm font-medium text-gray-600 hover:text-gray-900">
                Call 573-365-3366
              </a>
            </div>
          </div>
        </div>
        
        <!-- Right Column - Form -->
        <div>
          <DonationForm id="homepage" />
        </div>
      </div>
    </div>
  </div>
</section>
  
<!-- Prayer Request Section -->
<section id="prayer" class="py-20 bg-white">
  <div class="container mx-auto px-6">
    <div class="max-w-7xl mx-auto">
      <PrayerRequestForm />
    </div>
  </div>
</section>

<!-- Salvation Stories Marquee -->
<section id="salvation-stories" class="py-20 bg-white">
  <SalvationMarquee client:load />
</section>
<!-- Recent Services -->
<section id="services" class="py-20 bg-white">
  <div class="container mx-auto px-6">
    <div class="max-w-7xl mx-auto">
      <div class="text-center mb-16">
        <span class="inline-block px-4 py-2 bg-brand/10 text-brand text-sm font-medium mb-4">
          Watch and listen
        </span>
        <h2 class="text-4xl lg:text-5xl font-light mb-6 text-gray-900">Recent services</h2>
        <p class="text-lg text-gray-600 max-w-2xl mx-auto">
          Catch up on our latest worship services and messages
        </p>
      </div>
      
      <div id="video-loading" class="text-center py-16">
        <div class="inline-flex items-center gap-3">
          <div class="animate-spin rounded-full h-8 w-8 border-2 border-brand border-t-transparent"></div>
          <p class="text-lg text-gray-600">Loading recent services...</p>
        </div>
      </div>
      
      <div id="video-error" class="text-center py-16 hidden">
        <div class="bg-red-50 border border-red-200 p-8 max-w-md mx-auto">
          <p class="text-red-700 font-medium">Failed to load recent services</p>
          <p class="text-red-600 text-sm mt-1">Please try again later</p>
        </div>
      </div>
      
      <div id="video-container"></div>
    </div>
  </div>
</section>

<!-- Calendar Section -->
<section id="calendar" class="py-20 bg-white">
  <div class="container mx-auto px-6">
    <div class="max-w-7xl mx-auto">
      <div class="text-center mb-16">
        <span class="inline-block px-4 py-2 bg-brand/10 text-brand text-sm font-medium mb-4">
          Stay connected
        </span>
        <h2 class="text-4xl lg:text-5xl font-light mb-6 text-gray-900">Upcoming events</h2>
        <p class="text-lg text-gray-600 max-w-2xl mx-auto">
          Join us for worship, fellowship, and community events
        </p>
      </div>
      
              <div class="bg-white border border-gray-200 overflow-hidden rounded-2xl">
          <div class="p-8">
            <div class="w-full rounded-xl overflow-hidden" style="position: relative; padding-bottom: 75%;">
              <iframe 
                src="https://calendar.google.com/calendar/embed?src=lakeozarkdisciples%40gmail.com&ctz=America%2FChicago" 
                style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: 0;"
                title="Lake Ozark Christian Church Calendar"
                aria-label="Google Calendar showing upcoming church events"
              ></iframe>
            </div>
          </div>
        </div>
    </div>
  </div>
</section>

<!-- Toast Container -->
<div id="toast-container" class="fixed top-4 right-4 z-[150] space-y-2"></div>

<!-- Video Modal -->
<div id="video-modal" class="hidden fixed inset-0 bg-black bg-opacity-75 z-[150] flex items-center justify-center p-4" onclick="closeVideoModal()">
  <div class="bg-white rounded-lg max-w-4xl w-full max-h-[90vh] overflow-hidden" onclick="event.stopPropagation()">
    <div class="flex justify-between items-center p-4 border-b">
      <div class="flex items-center gap-3">
        <h3 id="video-modal-title" class="text-lg font-semibold text-gray-900"></h3>
        <span id="video-modal-season" class="hidden inline-flex items-center px-2.5 py-1 rounded-full text-xs font-semibold"></span>
      </div>
      <button 
        onclick="closeVideoModal()" 
        class="text-gray-400 hover:text-gray-600 transition-colors"
        aria-label="Close video"
      >
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
        </svg>
      </button>
    </div>
    <div class="aspect-video">
      <iframe 
        id="video-iframe"
        class="w-full h-full"
        frameborder="0"
        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
        allowfullscreen
      ></iframe>
    </div>
  </div>
</div>

<!-- Mapbox GL CSS - preload then apply -->
<link 
  rel="preload"
  href="https://api.mapbox.com/mapbox-gl-js/v3.3.0/mapbox-gl.css"
  as="style"
  onload="this.onload=null;this.rel='stylesheet'"
/>
<noscript><link href="https://api.mapbox.com/mapbox-gl-js/v3.3.0/mapbox-gl.css" rel="stylesheet" /></noscript>
<!-- Mapbox GL JS - loaded async to avoid render blocking -->
<script async src="https://api.mapbox.com/mapbox-gl-js/v3.3.0/mapbox-gl.js"></script>

<script>
  // Initialize Typed.js for hero text animation
  function initTypedHero() {
    const Typed = (window as any).Typed;
    if (!Typed) {
      setTimeout(initTypedHero, 100);
      return;
    }
    
    // Local visitor messages
    const localElement = document.getElementById('typed-local');
    if (localElement) {
      new Typed('#typed-local', {
        strings: [
          "There's a place for you here.",
          "Come as you are.",
          "You're always welcome.",
          "Faith, hope, and love.",
          "Growing together in Christ.",
          "Your church family awaits."
        ],
        typeSpeed: 45,
        backSpeed: 25,
        backDelay: 2500,
        startDelay: 500,
        loop: true,
        showCursor: true,
        cursorChar: '|'
      });
    }
    
    // Visitor messages
    const visitorElement = document.getElementById('typed-visitor');
    if (visitorElement) {
      new Typed('#typed-visitor', {
        strings: [
          "Welcome to the Lake.",
          "Worship with us this Sunday.",
          "A warm welcome awaits you.",
          "Find rest for your soul.",
          "All are welcome here."
        ],
        typeSpeed: 45,
        backSpeed: 25,
        backDelay: 2500,
        startDelay: 500,
        loop: true,
        showCursor: true,
        cursorChar: '|'
      });
    }
  }
  
  // Start typed.js when DOM is ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initTypedHero);
  } else {
    initTypedHero();
  }

  // Initialize Mapbox map and personalized location experience
  // Wait for Mapbox to be available (async loaded)
  function waitForMapbox() {
    return new Promise((resolve) => {
      if ((window as any).mapboxgl) {
        resolve(true);
        return;
      }
      // Check every 100ms for up to 10 seconds
      let attempts = 0;
      const maxAttempts = 100;
      const interval = setInterval(() => {
        attempts++;
        if ((window as any).mapboxgl) {
          clearInterval(interval);
          resolve(true);
        } else if (attempts >= maxAttempts) {
          clearInterval(interval);
          console.warn('Mapbox failed to load after 10s');
          resolve(false);
        }
      }, 100);
    });
  }

  document.addEventListener('DOMContentLoaded', async () => {
    // Wait for Mapbox to load (async)
    const mapboxLoaded = await waitForMapbox();
    const accessToken = 'pk.eyJ1IjoiZG9ub3JraXQiLCJhIjoiY21pdW9xb3I5MjEzajNlcHd6M2oycWZsNSJ9.5l169f8YSxjr5540qIkMoA';
    const churchAddress = '1560 Bagnell Dam Blvd, Lake Ozark, MO 65049';
    // Hardcoded coordinates for church (verified via API - no API call needed)
    const churchCoords: [number, number] = [-92.64159, 38.19839];
    
    const greetingEl = document.getElementById('location-greeting');
    const distanceEl = document.getElementById('distance-message');
    const directionsLink = document.getElementById('directions-link') as HTMLAnchorElement;
    
    // Initialize map first (shows church only)
    const mapContainer = document.getElementById('mapbox-map');
    let map: any = null;
    
    if (mapContainer && mapboxLoaded && (window as any).mapboxgl) {
      (window as any).mapboxgl.accessToken = accessToken;
      
      map = new (window as any).mapboxgl.Map({
        container: 'mapbox-map',
        style: 'mapbox://styles/mapbox/outdoors-v12',
        center: churchCoords,
        zoom: 15
      });
      
      // Navigation controls (zoom, compass)
      map.addControl(new (window as any).mapboxgl.NavigationControl(), 'top-right');
      
      // Fullscreen control
      map.addControl(new (window as any).mapboxgl.FullscreenControl(), 'top-right');
      
      // Geolocate control (find my location button)
      const geolocateControl = new (window as any).mapboxgl.GeolocateControl({
        positionOptions: { enableHighAccuracy: true },
        trackUserLocation: true,
        showUserHeading: true,
        showAccuracyCircle: true
      });
      map.addControl(geolocateControl, 'top-right');
      
      // Scale bar
      map.addControl(new (window as any).mapboxgl.ScaleControl({ maxWidth: 100 }), 'bottom-left');
      
      // Add church marker immediately
      map.on('load', () => {
        new (window as any).mapboxgl.Marker({ color: '#8B5A2B' })
          .setLngLat(churchCoords)
          .setPopup(new (window as any).mapboxgl.Popup().setHTML('<strong>Lake Ozark Christian Church</strong><br>1560 Bagnell Dam Blvd'))
          .addTo(map);
      });
    }
    
    // Function to show route on map
    async function showRouteOnMap(visitorLng: number, visitorLat: number) {
      if (!map) return;
      
      try {
        const directionsUrl = `https://api.mapbox.com/directions/v5/mapbox/driving/${visitorLng},${visitorLat};${churchCoords[0]},${churchCoords[1]}?geometries=geojson&overview=full&access_token=${accessToken}`;
        const directionsResponse = await fetch(directionsUrl);
        const directionsData = await directionsResponse.json();
        
        if (directionsData.routes && directionsData.routes.length > 0) {
          const route = directionsData.routes[0];
          const routeGeometry = route.geometry;
          
          // Remove existing route if any
          if (map.getSource('route')) {
            map.removeLayer('route');
            map.removeSource('route');
          }
          
          // Add route line
          map.addSource('route', {
            type: 'geojson',
            data: {
              type: 'Feature',
              properties: {},
              geometry: routeGeometry
            }
          });
          
          map.addLayer({
            id: 'route',
            type: 'line',
            source: 'route',
            layout: { 'line-join': 'round', 'line-cap': 'round' },
            paint: { 'line-color': '#8B5A2B', 'line-width': 4, 'line-opacity': 0.8 }
          });
          
          // Add visitor marker
          new (window as any).mapboxgl.Marker({ color: '#3B82F6' })
            .setLngLat([visitorLng, visitorLat])
            .setPopup(new (window as any).mapboxgl.Popup().setHTML('<strong>Your Location</strong>'))
            .addTo(map);
          
          // Fit map to route
          const bounds = new (window as any).mapboxgl.LngLatBounds();
          routeGeometry.coordinates.forEach((coord: number[]) => bounds.extend(coord));
          map.fitBounds(bounds, { padding: 50 });
          
          // Update distance message
          const durationMins = Math.round(route.duration / 60);
          const distanceMiles = (route.distance / 1609.34).toFixed(1);
          if (distanceEl) {
            distanceEl.textContent = `You're about ${distanceMiles} miles away â€” roughly ${durationMins} minutes by car.`;
          }
          
          // Update directions link
          if (directionsLink) {
            directionsLink.href = `https://www.google.com/maps/dir/${visitorLat},${visitorLng}/Lake+Ozark+Christian+Church,+1560+Bagnell+Dam+Blvd,+Lake+Ozark,+MO+65049?utm_source=lakeozarkdisciples&utm_medium=homepage&utm_campaign=visit_section&utm_content=directions_link`;
          }
        }
      } catch (e) {
        console.warn('Could not fetch directions:', e);
      }
    }
    
    // Check localStorage first for stored user location
    // Check both formats: the new JSON format and the old separate lat/lng format
    let userLocation: { lng: number; lat: number; city?: string; source: string } | null = null;
    
    const storedLocation = localStorage.getItem('user-location');
    const storedLat = localStorage.getItem('user-lat');
    const storedLng = localStorage.getItem('user-lng');
    
    // First try the JSON format
    if (storedLocation) {
      try {
        userLocation = JSON.parse(storedLocation);
        // Check if stored location is less than 30 days old (location doesn't change often)
        const storedTime = localStorage.getItem('user-location-time');
        if (storedTime) {
          const age = Date.now() - parseInt(storedTime);
          const thirtyDays = 30 * 24 * 60 * 60 * 1000;
          if (age > thirtyDays) {
            // Location is stale, clear it
            localStorage.removeItem('user-location');
            localStorage.removeItem('user-location-time');
            userLocation = null;
          }
        }
      } catch (e) {
        console.warn('Failed to parse stored location');
        localStorage.removeItem('user-location');
        localStorage.removeItem('user-location-time');
      }
    }
    
    // Fallback to separate lat/lng format (from LocationPermission component)
    if (!userLocation && storedLat && storedLng) {
      userLocation = {
        lng: parseFloat(storedLng),
        lat: parseFloat(storedLat),
        source: 'browser'
      };
    }
    
    // Function to save location to localStorage (persists across sessions)
    function saveLocationToStorage(lng: number, lat: number, city?: string, source: string = 'browser') {
      const locationData = { lng, lat, city, source, timestamp: Date.now() };
      localStorage.setItem('user-location', JSON.stringify(locationData));
      localStorage.setItem('user-location-time', Date.now().toString());
      // Also store in separate format for LocationPermission component compatibility
      localStorage.setItem('user-lat', lat.toString());
      localStorage.setItem('user-lng', lng.toString());
    }
    
    // Function to use stored or new location
    async function useLocation(lng: number, lat: number, city?: string, source: string = 'browser') {
      // Save to localStorage
      saveLocationToStorage(lng, lat, city, source);
      
      // Update greeting based on source and city
      if (greetingEl) {
        if (source === 'browser' || source === 'stored') {
          // Browser geolocation (precise) - we know they're nearby
          greetingEl.textContent = `ðŸ‘‹ Hello, neighbor!`;
          greetingEl.className = `inline-block px-4 py-2 bg-blue-100 text-blue-700 text-sm font-medium mb-6`;
        } else if (source === 'ip' && city) {
          // IP geolocation with city info
          const localCities = ['lake ozark', 'osage beach', 'camdenton', 'eldon', 'versailles', 'laurie', 'sunrise beach', 'gravois mills'];
          const isLocal = localCities.some((c: string) => city.toLowerCase().includes(c));
          
          if (isLocal) {
            greetingEl.textContent = `ðŸ‘‹ Hello, neighbor!`;
            greetingEl.className = `inline-block px-4 py-2 bg-green-100 text-green-700 text-sm font-medium mb-6`;
            if (distanceEl) distanceEl.textContent = `We're right here in your community. Stop by this Sunday!`;
          } else {
            const cityName = city.split(' ').map((w: string) => w.charAt(0).toUpperCase() + w.slice(1)).join(' ');
            greetingEl.textContent = `Welcome from ${cityName}!`;
            greetingEl.className = `inline-block px-4 py-2 bg-brand/10 text-brand text-sm font-medium mb-6`;
            if (distanceEl) distanceEl.textContent = `Visiting the Lake? We'd love to have you join us for worship.`;
          }
        }
      }
      
      // Wait for map to load then show route
      if (map) {
        if (map.loaded()) {
          await showRouteOnMap(lng, lat);
        } else {
          map.on('load', () => showRouteOnMap(lng, lat));
        }
      }
    }
    
    // If we have stored location with actual coordinates, use it (no permission needed!)
    if (userLocation && userLocation.lng && userLocation.lat) {
      // Reuse any valid stored location (browser or IP)
      await useLocation(userLocation.lng, userLocation.lat, userLocation.city, userLocation.source === 'browser' ? 'stored' : 'ip');
    } else {
      // Only request location if we don't have stored browser location
      // Check if user has already denied permission
      const permissionDenied = localStorage.getItem('location-permission-granted') === 'false';
      
      if (permissionDenied) {
        // User previously denied, fall back to IP location (less accurate but no permission needed)
        await fallbackToIPLocation();
      } else if ('geolocation' in navigator) {
        // Try browser geolocation (most accurate - actual coordinates)
        navigator.geolocation.getCurrentPosition(
          // Success - user granted permission
          async (position) => {
            const { longitude, latitude } = position.coords;
            await useLocation(longitude, latitude, undefined, 'browser');
          },
          // Error or denied - fall back to IP geolocation
          async (error) => {
            localStorage.setItem('location-permission-granted', 'false');
            await fallbackToIPLocation();
          },
          { enableHighAccuracy: true, timeout: 5000, maximumAge: 300000 }
        );
      } else {
        // Browser doesn't support geolocation, use IP
        await fallbackToIPLocation();
      }
    }
    
    // Fallback to IP-based geolocation
    async function fallbackToIPLocation() {
      try {
        const geoResponse = await fetch('https://geo.locc.us/where');
        const visitorData = await geoResponse.json();
        
        // Show route if we have coordinates
        if (visitorData && visitorData.latitude && visitorData.longitude) {
          const lng = parseFloat(visitorData.longitude);
          const lat = parseFloat(visitorData.latitude);
          const city = visitorData.city;
          
          // Save to localStorage and use location (greeting will be handled in useLocation)
          await useLocation(lng, lat, city, 'ip');
        }
      } catch (e) {
        console.warn('Could not fetch IP location');
      }
    }
  });

  // Toast notification functions
  function showToast(message: string, type: 'success' | 'error' | 'info' | 'warning' = 'info', duration: number = 5000) {
    const container = document.getElementById('toast-container');
    if (!container) return;

    const toastId = `toast-${Date.now()}`;
    const iconMap = {
      success: `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>`,
      error: `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>`,
      warning: `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.996-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path></svg>`,
      info: `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>`
    };

    const colorMap = {
      success: 'bg-green-50 border-green-200 text-green-800',
      error: 'bg-red-50 border-red-200 text-red-800', 
      warning: 'bg-yellow-50 border-yellow-200 text-yellow-800',
      info: 'bg-blue-50 border-blue-200 text-blue-800'
    };

    const toast = document.createElement('div');
    toast.id = toastId;
    toast.className = `${colorMap[type]} border rounded-lg p-4 shadow-lg max-w-sm toast-enter flex items-center gap-3`;
    toast.innerHTML = `
      <div class="flex-shrink-0">${iconMap[type]}</div>
      <div class="flex-1 text-sm font-medium">${message}</div>
      <button onclick="removeToast('${toastId}')" class="flex-shrink-0 hover:opacity-70 transition-opacity">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
        </svg>
      </button>
    `;

    container.appendChild(toast);

    // Auto remove after duration
    if (duration > 0) {
      setTimeout(() => removeToast(toastId), duration);
    }

    return toastId;
  }

  function removeToast(toastId: string) {
    const toast = document.getElementById(toastId);
    if (!toast) return;

    toast.classList.remove('toast-enter');
    toast.classList.add('toast-exit');
    
    setTimeout(() => {
      if (toast.parentNode) {
        toast.parentNode.removeChild(toast);
      }
    }, 300);
  }

  // Make removeToast globally available
  (window as any).removeToast = removeToast;

  // Live Service Countdown functionality with Flip Clock
  let countdownInterval: ReturnType<typeof setInterval> | null = null;
  let nextServiceTime: Date | null = null;
  let flipClockInstance: any = null;
  
  // Function to handle flip clock initialization (called by data-did-init)
  function handleFlipClockInit(tick: any) {
    flipClockInstance = tick;
  }
  
  // Make it globally available
  (window as any).handleFlipClockInit = handleFlipClockInit;
  
  async function fetchNextService() {
    const loadingEl = document.getElementById('countdown-loading');
    const errorEl = document.getElementById('countdown-error');
    const containerEl = document.getElementById('countdown-container');
    
    try {
      const response = await fetch('https://live.locc.us/graphql', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          query: `
            query {
              currentOrganization {
                servicesConnection {
                  services {
                    scheduleTime
                    content {
                      title
                    }
                  }
                }
              }
            }
          `
        })
      });
      
      if (!response.ok) throw new Error('Failed to fetch service data');
      
      const data = await response.json();
      const services = data.data?.currentOrganization?.servicesConnection?.services || [];
      
      // Find the next upcoming service
      const now = new Date();
      
      // Pre-process services with parsed dates for better performance
      const processedServices = services
        .filter(service => service.scheduleTime)
        .map(service => ({
          ...service,
          parsedTime: new Date(service.scheduleTime)
        }))
        .filter(service => service.parsedTime > now)
        .sort((a, b) => a.parsedTime.getTime() - b.parsedTime.getTime());
      
      const upcomingServices = processedServices;
      
      if (upcomingServices.length > 0) {
        const nextService = upcomingServices[0];
        nextServiceTime = nextService.parsedTime;
        
        // Service title: If available, use service title. Otherwise, fallback.
        const titleEl = document.getElementById('service-title');
        if (titleEl) {
          titleEl.textContent = nextService?.content?.title?.trim()
            ? nextService.content.title
            : 'Late Worship Service';
        }
        
        // Show countdown and start timer
        if (loadingEl) loadingEl.style.display = 'none';
        if (containerEl) containerEl.classList.remove('hidden');
        
        // Initialize the flip clock with the countdown
        initializeFlipClock();
        
      } else {
        // No upcoming services
        if (loadingEl) loadingEl.style.display = 'none';
        if (errorEl) {
          errorEl.classList.remove('hidden');
          const pEl = errorEl.querySelector('p');
          if (pEl) pEl.textContent = 'No upcoming services scheduled';
        }
      }
      
    } catch (error) {
      console.error('Error fetching service data:', error);
      if (loadingEl) loadingEl.style.display = 'none';
      if (errorEl) errorEl.classList.remove('hidden');
    }
  }
  
  function initializeFlipClock() {
    if (!nextServiceTime) return;
    
    // Wait for Tick to be available
    const waitForTick = () => {
      if ((window as any).Tick) {
        const Tick = (window as any).Tick;
        
        // Find the flip clock container
        const flipContainer = document.querySelector('.flip-clock-container');
        if (!flipContainer) return;
        
        // Calculate initial countdown
        const now = new Date().getTime();
        const distance = nextServiceTime!.getTime() - now;
        
        if (distance < 0) {
          showLiveNow();
          return;
        }
        
        // Create tick counter with countdown
        const counter = Tick.count.down(nextServiceTime, {
          format: ['d', 'h', 'm', 's']
        });
        
        counter.onupdate = function(value: number[]) {
          // Check if countdown is complete
          if (value.every((v: number) => v === 0)) {
            showLiveNow();
            return;
          }
          
          // Update the flip clock
          if (flipClockInstance) {
            flipClockInstance.value = value;
          }
        };
        
        counter.onended = function() {
          showLiveNow();
        };
        
        // Set initial value
        const days = Math.floor(distance / (1000 * 60 * 60 * 24));
        const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
        const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
        const seconds = Math.floor((distance % (1000 * 60)) / 1000);
        
        // Initialize the Tick DOM
        Tick.DOM.create(flipContainer, {
          value: [days, hours, minutes, seconds],
          didInit: function(tick: any) {
            flipClockInstance = tick;
            
            counter.onupdate = function(value: number[]) {
              if (value.every((v: number) => v === 0)) {
                showLiveNow();
                return;
              }
              tick.value = value;
            };
          },
          credits: false
        });
        
        // Remove any credits links that might appear
        setTimeout(() => {
          const creditsLinks = document.querySelectorAll('a[href*="pqina"], .tick-credits, .tick a');
          creditsLinks.forEach(el => el.remove());
        }, 100);
        
      } else {
        // Keep checking until Tick is loaded
        setTimeout(waitForTick, 100);
      }
    };
    
    waitForTick();
  }
  
  function showLiveNow() {
    const containerEl = document.getElementById('countdown-container');
    if (containerEl) {
      containerEl.innerHTML = `
        <div class="text-center py-8">
          <span class="inline-block px-6 py-3 bg-red-100 text-red-600 text-lg font-semibold mb-6 rounded-full animate-pulse">
            ðŸ”´ Live Now
          </span>
          <h2 class="text-3xl lg:text-4xl font-light mb-8 text-gray-900">
            Service is Live!
          </h2>
          <a 
            href="/live?utm_source=lakeozarkdisciples&utm_medium=countdown&utm_campaign=button" 
            class="inline-flex items-center justify-center px-10 py-5 bg-red-600 hover:bg-red-700 text-white font-semibold rounded-lg transition-all duration-300 text-xl"
          >
            Join Live Stream Now
          </a>
        </div>
      `;
    }
  }
  
  // Initialize countdown
  fetchNextService();
  
  // Re-fetch service data every 30 minutes
  setInterval(fetchNextService, 30 * 60 * 1000);
  
  let currentVideoPage = 0;
  interface VideoData {
    id: string;
    title: string;
    thumbnail?: string;
  }
  let allVideos: VideoData[] = [];
  const videosPerPage = 3;

  async function loadVideos() {
    const loadingEl = document.getElementById('video-loading');
    const errorEl = document.getElementById('video-error');
    const containerEl = document.getElementById('video-container');
    
    try {
      const response = await fetch('/api/videos.json');
      
      if (!response.ok) {
        const errorText = await response.text();
        console.error('API response error:', errorText);
        throw new Error(`Failed to fetch videos: ${response.status} ${response.statusText}`);
      }
      
      const responseData = await response.json();
      
      // Check if response has error property
      if (responseData.error) {
        throw new Error(responseData.error);
      }
      
      allVideos = Array.isArray(responseData) ? responseData : [];
      
      if (loadingEl) loadingEl.style.display = 'none';
      
      if (allVideos.length > 0) {
        displayVideos();
      } else {
        if (errorEl) {
          errorEl.style.display = 'block';
          errorEl.innerHTML = '<div class="bg-yellow-50 border border-yellow-200 p-8 max-w-md mx-auto"><p class="text-yellow-700 font-medium">No videos available</p><p class="text-yellow-600 text-sm mt-1">Check back later for new content</p></div>';
        }
      }
      
    } catch (error) {
      console.error('Error loading videos:', error);
      if (loadingEl) loadingEl.style.display = 'none';
      if (errorEl) {
        errorEl.style.display = 'block';
        errorEl.innerHTML = `<div class="bg-red-50 border border-red-200 p-8 max-w-md mx-auto"><p class="text-red-700 font-medium">Failed to load recent services</p><p class="text-red-600 text-sm mt-1">${error.message}</p></div>`;
      }
    }
  }

  function displayVideos() {
    const containerEl = document.getElementById('video-container');
    
    if (!containerEl || allVideos.length === 0) return;

    const startIndex = 0;
    const endIndex = Math.min(videosPerPage * (currentVideoPage + 1), allVideos.length);
    const videosToShow = allVideos.slice(startIndex, endIndex);
    
    const videoGridHTML = `
      <div class="space-y-12">
        <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-8" id="video-grid">
          ${videosToShow.map((video) => `
             <div class="video-item bg-white border border-gray-200 overflow-hidden group hover:shadow-lg transition-all duration-300 rounded-xl">
               <button 
                 onclick="openVideoModal('${video.id}', '${video.title.replace(/"/g, '&quot;')}')"
                 class="block w-full text-left"
                 aria-label="Watch ${video.title}"
               >
                 <div class="relative aspect-video overflow-hidden">
                   <img 
                     id="thumbnail-${video.id}"
                     src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='480' height='270' viewBox='0 0 480 270'%3E%3Crect width='480' height='270' fill='%23f3f4f6'/%3E%3Ctext x='240' y='135' text-anchor='middle' dy='0.35em' font-family='Arial, sans-serif' font-size='16' fill='%23666'%3ELoading...%3C/text%3E%3C/svg%3E"
                     alt="Thumbnail for ${video.title}"
                     class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-500"
                     data-video-id="${video.id}"
                     data-video-title="${video.title.replace(/"/g, '&quot;')}"
                   />
                   <div class="absolute inset-0 bg-black/0 group-hover:bg-black/30 transition-all duration-300 flex items-center justify-center">
                     <div class="opacity-0 group-hover:opacity-100 transition-opacity duration-300 bg-white/20 backdrop-blur-sm rounded-full p-4">
                       <svg class="w-12 h-12 text-white" fill="currentColor" viewBox="0 0 24 24">
                         <path d="M8 5v14l11-7z"/>
                       </svg>
                     </div>
                   </div>
                 </div>
                 <div class="p-6">
                   <h3 class="font-semibold text-lg text-gray-900 group-hover:text-brand transition-colors duration-300 leading-tight">${video.title}</h3>
                 </div>
               </button>
             </div>
           `).join('')}
        </div>
        ${endIndex < allVideos.length ? `
          <div class="text-center">
            <button
              id="view-more-btn"
              class="inline-flex items-center justify-center px-8 py-4 bg-brand hover:bg-brand-dark text-white font-medium rounded-lg transition-all duration-300"
            >
              View More Services
            </button>
          </div>
        ` : ''}
      </div>
    `;
    
    containerEl.innerHTML = videoGridHTML;
    setupVideoGrid();
    
    // Generate dynamic thumbnails for videos that need them
    generateDynamicThumbnails(videosToShow);
  }

  function setupVideoGrid() {
    const viewMoreBtn = document.getElementById('view-more-btn');
    
    if (viewMoreBtn) {
      viewMoreBtn.addEventListener('click', () => {
        currentVideoPage++;
        displayVideos();
      });
    }
  }

  // Dynamic thumbnail generation variables
  let thumbnailGenerator;

  // Initialize thumbnail generator
  async function initThumbnailGenerator() {
    thumbnailGenerator = await import('../utils/clientThumbnailGenerator.js');
  }

  // Function to generate dynamic thumbnails for videos
  async function generateDynamicThumbnails(videos) {
    if (!thumbnailGenerator) {
      await initThumbnailGenerator();
    }

    for (const video of videos) {
      const thumbnailEl = document.getElementById(`thumbnail-${video.id}`);
      if (!thumbnailEl || !(thumbnailEl instanceof HTMLImageElement)) continue;

      try {
        // Generate dynamic thumbnail for ALL videos with church background
        const dynamicThumbnail = await thumbnailGenerator.getVideoThumbnail({
          id: video.id,
          title: video.title
        });

        // Make sure we got a valid data URL string, not a Promise
        if (dynamicThumbnail && typeof dynamicThumbnail === 'string' && dynamicThumbnail !== thumbnailEl.src) {
          // Replace placeholder with generated thumbnail immediately
          thumbnailEl.src = dynamicThumbnail;
        }
      } catch (error) {
        console.warn(`Failed to generate thumbnail for ${video.id}:`, error);
      }
    }
  }

  // Preload thumbnails for better performance
  async function preloadAllThumbnails() {
    if (!thumbnailGenerator) {
      await initThumbnailGenerator();
    }
    if (allVideos.length > 0) {
      thumbnailGenerator.preloadThumbnails(allVideos);
    }
  }

  // Clear cache on initial load to force regeneration with new church background
  loadVideos();
  
  document.addEventListener('astro:page-load', () => {
    currentVideoPage = 0;
    allVideos = [];
    loadVideos();
  });

  // Video Modal Functions
  async function openVideoModal(videoId: string, videoTitle: string) {
    const modal = document.getElementById('video-modal');
    const iframe = document.getElementById('video-iframe') as HTMLIFrameElement;
    const title = document.getElementById('video-modal-title');
    const seasonBadge = document.getElementById('video-modal-season');
    
    if (modal && iframe && title) {
      title.textContent = videoTitle;
      iframe.src = `https://www.youtube.com/embed/${videoId}?autoplay=1&rel=0`;
      modal.classList.remove('hidden');
      document.body.style.overflow = 'hidden'; // Prevent background scrolling
      
      // Get liturgical season for the video
      if (seasonBadge && thumbnailGenerator) {
        try {
          const { parseDateFromTitle, getLiturgicalSeason } = await import('../utils/clientThumbnailGenerator.js');
          const parsedDate = parseDateFromTitle(videoTitle);
          
          if (parsedDate) {
            const normalizedDate = new Date(parsedDate.getFullYear(), parsedDate.getMonth(), parsedDate.getDate(), 0, 0, 0, 0);
            const liturgical = getLiturgicalSeason(normalizedDate);
            
            if (liturgical.season !== 'Default') {
              seasonBadge.textContent = liturgical.season;
              seasonBadge.style.backgroundColor = liturgical.color;
              seasonBadge.style.color = '#ffffff';
              seasonBadge.classList.remove('hidden');
            } else {
              seasonBadge.classList.add('hidden');
            }
          } else {
            seasonBadge.classList.add('hidden');
          }
        } catch (error) {
          console.warn('Failed to get liturgical season:', error);
          if (seasonBadge) seasonBadge.classList.add('hidden');
        }
      }
    }
  }

  function closeVideoModal() {
    const modal = document.getElementById('video-modal');
    const iframe = document.getElementById('video-iframe') as HTMLIFrameElement;
    
    if (modal && iframe) {
      modal.classList.add('hidden');
      iframe.src = ''; // Stop video playback
      document.body.style.overflow = ''; // Restore scrolling
    }
  }

  // Close modal when clicking outside or pressing Escape
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
      closeVideoModal();
    }
  });

  // Make functions globally available
  (window as any).openVideoModal = openVideoModal;
  (window as any).closeVideoModal = closeVideoModal;

</script>

<style>
  * {
    font-family: 'Albert Sans', system-ui, sans-serif;
  }
  
  h1, h2, h3, h4, h5, h6 {
    font-family: 'Albert Sans', system-ui, sans-serif;
  }

  /* Smooth scrolling for the entire page */
  html {
    scroll-behavior: smooth;
  }

  /* Ensure sections are properly centered when navigated to */
  section[id] {
    scroll-margin-top: 2rem;
  }

  /* For mobile devices, add more top margin */
  @media (max-width: 768px) {
    section[id] {
      scroll-margin-top: 1rem;
    }
  }

  /* Flip Clock Custom Styles */
  
  /* Hide the pqina credits link */
  .tick-credits,
  .tick-flip-panel-text-wrapper + a,
  .tick a[href*="pqina"],
  a[href*="pqina.nl"],
  a[href*="pqina"],
  .flip-clock-container a,
  .tick > a,
  [data-credits],
  .tick-credits-text {
    display: none !important;
    visibility: hidden !important;
    opacity: 0 !important;
    pointer-events: none !important;
    position: absolute !important;
    left: -9999px !important;
  }

  .flip-clock-container {
    display: flex;
    justify-content: center;
    gap: 1rem;
  }

  .flip-clock-container .tick {
    font-size: 1rem;
    white-space: nowrap;
  }

  .flip-clock-container .tick-flip,
  .flip-clock-container .tick-text-inline {
    font-size: 2.5em;
  }

  .flip-clock-container .tick-label {
    margin-top: 0.5em;
    font-size: 0.875rem;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: #6b7280;
    text-align: center;
    display: block;
  }

  .flip-clock-container .tick-flip-panel {
    background: linear-gradient(180deg, #1f2937 0%, #111827 100%);
    color: #f9fafb;
    border-radius: 0.375rem;
  }

  .flip-clock-container .tick-flip-panel-back {
    background: linear-gradient(180deg, #111827 0%, #0f172a 100%);
  }

  .flip-clock-container .tick-flip-panel-front {
    background: linear-gradient(180deg, #1f2937 0%, #111827 100%);
  }

  .flip-clock-container .tick-group {
    margin: 0 0.25rem;
    text-align: center;
  }

  /* Make flip panels have shadow for depth */
  .flip-clock-container .tick-flip {
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
  }

  /* Responsive adjustments for flip clock */
  @media (min-width: 1024px) {
    .flip-clock-container .tick-flip,
    .flip-clock-container .tick-text-inline {
      font-size: 3.5em;
    }
  }

  /* Typed.js cursor styling */
  .typed-cursor {
    color: white;
    opacity: 0.8;
    animation: blink 0.7s infinite;
  }

  @keyframes blink {
    0%, 100% { opacity: 1; }
    50% { opacity: 0; }
  }

  .tooltip {
    z-index: 50;
    transform: translateX(-50%);
    left: 50%;
  }

  .tooltip::after {
    content: '';
    position: absolute;
    top: 100%;
    left: 50%;
    margin-left: -5px;
    border-width: 5px;
    border-style: solid;
    border-color: #1f2937 transparent transparent transparent;
  }

  /* Toast animations */
  @keyframes slideInFromRight {
    from {
      transform: translateX(100%);
      opacity: 0;
    }
    to {
      transform: translateX(0);
      opacity: 1;
    }
  }

  @keyframes slideOutToRight {
    from {
      transform: translateX(0);
      opacity: 1;
    }
    to {
      transform: translateX(100%);
      opacity: 0;
    }
  }

  .toast-enter {
    animation: slideInFromRight 0.3s ease-out;
  }

  .toast-exit {
    animation: slideOutToRight 0.3s ease-in;
  }

  /* Hero section offset for header/banner */
  .hero-section {
    min-height: calc(100vh - var(--header-offset, 0px));
    min-height: calc(100dvh - var(--header-offset, 0px));
  }
</style>

<script>
  // Calculate and set header offset for hero section
  function updateHeaderOffset() {
    const topBar = document.querySelector('.top-bar') as HTMLElement | null;
    const mainHeader = document.querySelector('.main-header') as HTMLElement | null;
    const seasonalBanner = document.querySelector('.seasonal-banner') as HTMLElement | null;
    
    let totalOffset = 0;
    
    // Add top bar height (desktop only)
    if (topBar && window.getComputedStyle(topBar).display !== 'none') {
      totalOffset += topBar.offsetHeight;
    }
    
    // Add main header height
    if (mainHeader) {
      totalOffset += mainHeader.offsetHeight;
    }
    
    // Add seasonal banner height if visible
    if (seasonalBanner) {
      totalOffset += seasonalBanner.offsetHeight;
    }
    
    document.documentElement.style.setProperty('--header-offset', `${totalOffset}px`);
  }
  
  // Run on load and resize
  updateHeaderOffset();
  window.addEventListener('resize', updateHeaderOffset);
  
  // Watch for DOM changes (seasonal banner appearing)
  const observer = new MutationObserver(updateHeaderOffset);
  const bannerRoot = document.getElementById('seasonal-banner-root');
  if (bannerRoot) {
    observer.observe(bannerRoot, { childList: true, subtree: true });
  }
  
  // Also observe document.body for late-loading components
  observer.observe(document.body, { childList: true, subtree: true });
</script>
</Layout>
