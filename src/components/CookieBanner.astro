---
const color = {
  bg: 'bg-white',
  text: 'text-gray-900', 
  textSecondary: 'text-gray-600',
  icon: 'text-brand',
  iconBg: 'bg-brand/10',
  button: 'bg-brand hover:bg-brand-dark',
  buttonSecondary: 'bg-gray-900 hover:bg-gray-800',
  buttonTertiary: 'bg-transparent hover:bg-gray-50 border-2 border-gray-200 hover:border-gray-300'
};
---

<div 
  id="cookie-banner-backdrop"
  class="fixed inset-0 bg-black/50 backdrop-blur-sm z-[99] hidden"
  aria-hidden="true"
>
</div>

<div 
  id="cookie-banner" 
  class={`fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 z-[100] ${color.bg} shadow-2xl rounded-xl p-4 sm:p-6 w-[95%] sm:w-[90%] md:w-[480px] lg:w-[520px] max-h-[90vh] overflow-y-auto animate-slideUp hidden border border-gray-200`}
  role="dialog"
  aria-labelledby="cookie-title"
  aria-describedby="cookie-description"
  tabindex="-1"
>
  <button
    id="close-cookie-banner"
    class={`${color.textSecondary} hover:${color.text} focus:ring-2 focus:ring-brand focus:outline-none transition absolute top-4 right-4 p-1.5 rounded-full hover:bg-gray-100`}
    aria-label="Close cookie settings"
  >
    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
    </svg>
  </button>

  <div class="space-y-5">
    <!-- Header Section -->
    <div class="text-center">
      <div class={`${color.iconBg} rounded-full p-3 w-12 h-12 mx-auto mb-4 flex items-center justify-center`}>
        <svg 
          xmlns="http://www.w3.org/2000/svg" 
          class={`h-6 w-6 ${color.icon}`}
          fill="none" 
          viewBox="0 0 24 24" 
          stroke="currentColor"
          aria-hidden="true"
        >
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
        </svg>
      </div>
      
      <span class="inline-block px-3 py-1.5 bg-brand/10 text-brand text-xs font-medium mb-3 rounded-full">
        Privacy Settings
      </span>
      <h3 id="cookie-title" class={`text-xl lg:text-2xl font-light ${color.text} mb-3 leading-tight`}>Cookie Preferences</h3>
      <p id="cookie-description" class={`text-sm ${color.textSecondary} leading-relaxed`}>
        We respect your privacy. Please choose which cookies you'd like to allow.
      </p>
    </div>

    <!-- Cookie Options -->
    <div class="space-y-3">
      <!-- Essential Cookies -->
      <div class="bg-gray-50 rounded-lg p-4 border border-gray-200">
        <div class="flex items-start gap-3">
          <div class="flex items-center h-5 mt-0.5">
            <input
              id="essential-cookies"
              type="checkbox"
              checked
              disabled
              class="h-4 w-4 text-brand border-gray-300 rounded focus:ring-2 focus:ring-brand focus:ring-offset-2"
              aria-describedby="essential-cookies-description"
            />
            <span class="sr-only-focusable">Essential cookies are always enabled and cannot be disabled</span>
          </div>
          <div class="flex-1">
            <div class="flex items-center gap-2 mb-1">
              <label for="essential-cookies" class="text-sm font-semibold text-gray-900">Essential Cookies</label>
              <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                Required
              </span>
            </div>
            <p id="essential-cookies-description" class="text-xs text-gray-600 leading-relaxed">
              Necessary for the website to function properly. Enable core functionality like security and accessibility.
            </p>
          </div>
        </div>
      </div>

      <!-- Analytics Cookies -->
      <div class="bg-white rounded-lg p-4 border-2 border-gray-200 hover:border-brand/30 transition-colors">
        <div class="flex items-start gap-3">
          <div class="flex items-center h-5 mt-0.5">
            <input
              id="analytics-cookies"
              type="checkbox"
              checked={false}
              class="h-4 w-4 text-brand border-gray-300 rounded focus:ring-2 focus:ring-brand focus:ring-offset-2"
              aria-describedby="analytics-cookies-description"
            />
            <span id="analytics-tooltip" class="sr-only-focusable"></span>
          </div>
          <div class="flex-1">
            <div class="flex items-center gap-2 mb-1">
              <label for="analytics-cookies" class="text-sm font-semibold text-gray-900">Analytics Cookies</label>
              <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                Optional
              </span>
            </div>
            <p id="analytics-cookies-description" class="text-xs text-gray-600 leading-relaxed">
              Help us understand how visitors use our website with anonymous usage data.
            </p>
          </div>
        </div>
      </div>

      <!-- Personalization Cookies -->
      <div class="bg-white rounded-lg p-4 border-2 border-gray-200 hover:border-brand/30 transition-colors">
        <div class="flex items-start gap-3">
          <div class="flex items-center h-5 mt-0.5">
            <input
              id="personalization-cookies"
              type="checkbox"
              checked={false}
              class="h-4 w-4 text-brand border-gray-300 rounded focus:ring-2 focus:ring-brand focus:ring-offset-2"
              aria-describedby="personalization-cookies-description"
            />
            <span id="personalization-tooltip" class="sr-only-focusable"></span>
          </div>
          <div class="flex-1">
            <div class="flex items-center gap-2 mb-1">
              <label for="personalization-cookies" class="text-sm font-semibold text-gray-900">Personalization Cookies</label>
              <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-purple-100 text-purple-800">
                Optional
              </span>
            </div>
            <p id="personalization-cookies-description" class="text-xs text-gray-600 leading-relaxed">
              Remember your preferences for a more tailored experience.
            </p>
          </div>
        </div>
      </div>
    </div>

    <!-- Data Processing Information -->
    <div class="bg-brand/5 rounded-lg p-4 border border-brand/20">
      <div class="flex items-start gap-3">
        <div class={`${color.iconBg} rounded-full p-1.5 flex-shrink-0`}>
          <svg xmlns="http://www.w3.org/2000/svg" class={`h-4 w-4 ${color.icon}`} fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
          </svg>
        </div>
        <div class="flex-1">
          <h4 class="text-sm font-semibold text-gray-900 mb-1">Data Processing</h4>
          <p class="text-xs text-gray-600 leading-relaxed">
            We share limited data with analytics providers to improve our services. Your personal information is never sold. 
            Review our <a href="/privacy" class="text-brand hover:text-brand-dark underline font-medium focus:ring-2 focus:ring-brand focus:outline-none rounded">Privacy Policy</a> for details.
          </p>
        </div>
      </div>
    </div>

    <!-- Action Buttons -->
    <div class="space-y-3">
      <button
        id="accept-cookies"
        class={`w-full ${color.button} text-white font-medium py-3 px-6 rounded-lg transition-all duration-300 transform hover:scale-105 hover:shadow-lg focus:ring-2 focus:ring-brand focus:ring-offset-2 focus:outline-none`}
      >
        Accept All Cookies
      </button>
      
      <div class="grid sm:grid-cols-2 gap-3">
        <button
          id="save-preferences"
          class={`${color.buttonSecondary} text-white font-medium py-2.5 px-4 rounded-lg transition-all duration-300 hover:shadow-lg focus:ring-2 focus:ring-brand focus:ring-offset-2 focus:outline-none text-sm`}
        >
          Save Preferences
        </button>
        <button
          id="reject-cookies"
          class={`${color.buttonTertiary} text-gray-700 font-medium py-2.5 px-4 rounded-lg transition-all duration-300 hover:shadow-lg focus:ring-2 focus:ring-brand focus:ring-offset-2 focus:outline-none text-sm`}
        >
          Essential Only
        </button>
      </div>
    </div>

    <!-- Footer Note -->
    <div class="text-center pt-3 border-t border-gray-200">
      <p class="text-gray-500 text-xs leading-relaxed">
        Change preferences anytime via 
        <span class="inline-flex items-center gap-1 font-medium">
          Your Privacy Choices 
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 30 14" class="w-5 h-2.5 inline" aria-hidden="true">
            <path fill="#FFFFFF" d="M7.4,12.8h6.8l3.1-11.6H7.4C4.2,1.2,1.6,3.8,1.6,7S4.2,12.8,7.4,12.8z"/>
            <path fill="#0066FF" d="M22.6,0H7.4c-3.9,0-7,3.1-7,7s3.1,7,7,7h15.2c3.9,0,7-3.1,7-7S26.4,0,22.6,0z M1.6,7c0-3.2,2.6-5.8,5.8-5.8h9.9l-3.1,11.6H7.4C4.2,12.8,1.6,10.2,1.6,7z"/>
            <path fill="#FFFFFF" d="M24.6,4c0.2,0.2,0.2,0.6,0,0.8l0,0L22.5,7l2.2,2.2c0.2,0.2,0.2,0.6,0,0.8c-0.2,0.2-0.6,0.2-0.8,0l0,0l-2.2-2.2L19.5,10c-0.2,0.2-0.6,0.2-0.8,0c-0.2-0.2-0.2-0.6,0-0.8l0,0L20.8,7l-2.2-2.2c-0.2-0.2-0.2-0.6,0-0.8c0.2-0.2,0.6-0.2,0.8,0l0,0l2.2,2.2L23.8,4C24,3.8,24.4,3.8,24.6,4z"/>
            <path fill="#0066FF" d="M12.7,4.1c0.2,0.2,0.3,0.6,0.1,0.8l0,0L8.6,9.8C8.5,9.9,8.4,10,8.3,10c-0.2,0.1-0.5,0.1-0.7-0.1l0,0L5.4,7.7c-0.2-0.2-0.2-0.6,0-0.8c0.2-0.2,0.6-0.2,0.8,0l0,0L8,8.6l3.8-4.5C12,3.9,12.4,3.9,12.7,4.1z"/>
          </svg>
        </span>
        in the footer.
      </p>
    </div>
  </div>
</div>

<style>
  * {
    font-family: 'Albert Sans', system-ui, sans-serif;
  }
  
  h1, h2, h3, h4, h5, h6 {
    font-family: 'Albert Sans', system-ui, sans-serif;
  }

  @keyframes slideUp {
    from {
      transform: translate(-50%, -40%);
      opacity: 0;
    }
    to {
      transform: translate(-50%, -50%);
      opacity: 1;
    }
  }

  .animate-slideUp {
    animation: slideUp 0.3s ease-out;
  }

  .sr-only-focusable {
    position: absolute;
    width: 1px;
    height: 1px;
    padding: 0;
    margin: -1px;
    overflow: hidden;
    clip: rect(0, 0, 0, 0);
    white-space: nowrap;
    border: 0;
  }

  .sr-only-focusable:not(:focus) {
    position: absolute;
    width: 1px;
    height: 1px;
    padding: 0;
    margin: -1px;
    overflow: hidden;
    clip: rect(0, 0, 0, 0);
    white-space: nowrap;
    border: 0;
  }

  .sr-only-focusable:focus {
    position: fixed;
    top: 0.5rem;
    left: 50%;
    transform: translateX(-50%);
    width: auto;
    height: auto;
    padding: 0.5rem 1rem;
    margin: 0;
    overflow: visible;
    clip: auto;
    white-space: normal;
    background-color: #8B5A2B;
    color: white;
    border-radius: 0.375rem;
    z-index: 101;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
  }
</style>
<script>
  declare global {
    interface Window {
      showCookieSettings: () => void;
      dataLayer: any[];
      gtag: (...args: any[]) => void;
      Sentry: any;
    }
  }

  interface CookiePreferences {
    essential: boolean;
    analytics: boolean;
    personalization: boolean;
  }

  function showBanner() {
    const banner = document.getElementById('cookie-banner');
    const backdrop = document.getElementById('cookie-banner-backdrop');
    if (banner && backdrop) {
      banner.classList.remove('hidden');
      backdrop.classList.remove('hidden');
      // Focus the banner when shown
      banner.focus();
    }
  }

  window.showCookieSettings = showBanner;

  function hideBanner() {
    const banner = document.getElementById('cookie-banner');
    const backdrop = document.getElementById('cookie-banner-backdrop');
    if (banner && backdrop) {
      banner.classList.add('hidden');
      backdrop.classList.add('hidden');
    }
  }

  function getCookie(name: string) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop()?.split(';').shift();
    return null;
  }

  function loadGoogleAnalytics() {
    // Only proceed if the script hasn't been loaded yet
    if (!document.querySelector('script[src*="googletagmanager"]')) {
      // Create and append the first script (gtag.js)
      const gtagScript = document.createElement('script');
      gtagScript.async = true;
      gtagScript.src = 'https://www.googletagmanager.com/gtag/js?id=G-T4PD8XC0SC';
      document.head.appendChild(gtagScript);

      // Create and append the configuration script
      const configScript = document.createElement('script');
      configScript.textContent = `
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-T4PD8XC0SC');
      `;
      document.head.appendChild(configScript);
      console.log(
  '[G_CONSENT] You have consented to Google Analytics by accepting the cookie banner, enabling analytics cookies, or clicking "Accept All Cookies." Google Analytics is now being loaded.'
);
    } else {
      console.log('[G_LOADED] Google Analytics was already loaded, we have nothing to do here.');
    }
  }

  function loadSentry() {
    // Check if Sentry is available
    if (window.Sentry) {
      try {
        // Initialize Sentry if not already initialized
        if (!window.Sentry.getCurrentHub || !window.Sentry.getCurrentHub().getClient()) {
          window.Sentry.init({
            dsn: "https://d4be77c82b4c10fc61de7d57705ddc7b@o4509496802738176.ingest.us.sentry.io/4509496803786752",
            integrations: [
              window.Sentry.browserTracingIntegration(),
              window.Sentry.replayIntegration({
                maskAllText: false,
                blockAllMedia: false,
              }),
            ],
            // Performance Monitoring
            tracesSampleRate: 1.0,
            // Session Replay
            replaysSessionSampleRate: 0.1,
            replaysOnErrorSampleRate: 1.0,
            environment: "production",
          });
          console.log('[SENTRY_CONSENT] You have consented to Sentry Analytics and Logging by accepting the cookie banner, enabling analytics cookies, or clicking "Accept All Cookies.');
        } else {
          // Re-enable Sentry if it was disabled
          const hub = window.Sentry.getCurrentHub();
          const client = hub.getClient();
          if (client) {
            client.getOptions().enabled = true;
            console.log('[SENTRY_CONSENT] Sentry error monitoring has been re-enabled.');
          }
        }
      } catch (error) {
        console.error('[SENTRY_ERROR] Failed to enable Sentry:', error);
      }
    } else {
      console.log('[SENTRY_UNAVAILABLE] Sentry is not available on this page.');
    }
  }

  function unloadGoogleAnalytics() {
    console.log('[G_UNLOAD] User has rejected Google Analytics, we are unloading it.');
    
    // Remove the gtag.js script
    const gtagScript = document.querySelector('script[src*="googletagmanager"]');
    if (gtagScript) {
      gtagScript.remove();
      console.log('[G_UNLOAD] User has rejected Google Analytics. It has been successfully unloaded.');
    }

    // Remove the configuration script by finding all inline scripts and checking their content
    const scripts = document.getElementsByTagName('script');
    for (let i = 0; i < scripts.length; i++) {
      const script = scripts[i];
      if (!script.src && script.textContent?.includes('gtag')) {
        script.remove();
        console.log('[G_UNLOAD] Removed gtag configuration script');
        break;
      }
    }

    // Clear any existing dataLayer
    if (window.dataLayer) {
      window.dataLayer = [];
      console.log('[G_UNLOAD] Successfully cleared dataLayer and removed all analytics data');
    }

    // Set gtag to undefined instead of trying to delete it
    if (window.gtag) {
      window.gtag = undefined as any;
      console.log('[G_UNLOAD] Successfully removed gtag function from window object');
    }
    
    console.log('[G_UNLOAD] Google Analytics has been successfully unloaded and all tracking data cleared');
  }

  function unloadSentry() {
    console.log('[SENTRY_UNLOAD] User has rejected analytics cookies, disabling Sentry error monitoring.');
    
    if (window.Sentry) {
      try {
        // Disable Sentry instead of unloading it completely
        if (window.Sentry.getCurrentHub) {
          const hub = window.Sentry.getCurrentHub();
          const client = hub.getClient();
          if (client) {
            client.getOptions().enabled = false;
          }
        }
        
        // Clear any existing scope data
        if (window.Sentry.configureScope) {
          window.Sentry.configureScope((scope) => {
            scope.clear();
          });
        }
        
        console.log('[SENTRY_UNLOAD] Sentry has been successfully disabled and all tracking data cleared');
      } catch (error) {
        console.error('[SENTRY_UNLOAD_ERROR] Failed to properly disable Sentry:', error);
      }
    } else {
      console.log('[SENTRY_UNLOAD] Sentry was not loaded, nothing to disable.');
    }
  }

  function handleCookieConsent(preferences: CookiePreferences) {
    const date = new Date();
    date.setTime(date.getTime() + (365 * 24 * 60 * 60 * 1000));
    
    // Set the main cookie preferences
    document.cookie = `cookie-preferences=${JSON.stringify(preferences)};expires=${date.toUTCString()};path=/;SameSite=Strict`;
    
    // Set a simpler cookie for quick checks
    let consentLevel = 'none';
    if (preferences.analytics && preferences.personalization) {
      consentLevel = 'all';
    } else if (preferences.analytics || preferences.personalization) {
      consentLevel = 'partial';
    } else if (preferences.essential) {
      consentLevel = 'required';
    }
    document.cookie = `cookie-consent=${consentLevel};expires=${date.toUTCString()};path=/;SameSite=Strict`;
    
    // Load or unload Google Analytics based on analytics preference
    if (preferences.analytics) {
      loadGoogleAnalytics();
      loadSentry();
    } else {
      unloadGoogleAnalytics();
      unloadSentry();
    }
    
    // Dispatch event for other components to react to cookie changes
    window.dispatchEvent(new CustomEvent('cookiePreferencesChanged', { 
      detail: { preferences, consentLevel } 
    }));
    
    hideBanner();
  }

  function getCurrentPreferences(): CookiePreferences {
    const analytics = document.getElementById('analytics-cookies') as HTMLInputElement;
    const personalization = document.getElementById('personalization-cookies') as HTMLInputElement;
    
    return {
      essential: true, // Always enabled
      analytics: analytics?.checked || false,
      personalization: personalization?.checked || false
    };
  }

  async function checkComplianceRequirements() {
    try {
      // Check if user is in a region that requires cookie consent
      const response = await fetch('https://geo.locc.us/where');
      if (!response.ok) {
        // If geolocation fails, show banner as fallback (better safe than sorry)
        console.log('[COOKIE_COMPLIANCE] Geolocation check failed, showing banner as fallback');
        setTimeout(showBanner, 3000);
        return;
      }
      
      const geoData = await response.json();
      console.log('[COOKIE_COMPLIANCE] Geolocation data:', geoData);
      
      // Check if any privacy laws apply to this user's location
      // GDPR: General Data Protection Regulation (EU)
      // CCPA: California Consumer Privacy Act (California, US) 
      // LGPD: Lei Geral de Proteção de Dados (Brazil)
      // PIPEDA: Personal Information Protection and Electronic Documents Act (Canada)
      // APPA: Australian Privacy Principles Act (Australia)
      const privacyLaws = {
        gdpr: geoData.gdpr || false,
        ccpa: geoData.ccpa || geoData.cpa || false, // Check both ccpa and cpa for compatibility
        lgpd: geoData.lgpd || false,
        pipeda: geoData.pipeda || false,
        appa: geoData.appa || false
      };
      
      const requiresConsent = privacyLaws.gdpr || privacyLaws.ccpa || privacyLaws.lgpd || privacyLaws.pipeda || privacyLaws.appa;
      
      console.log('[COOKIE_COMPLIANCE] Privacy law status:', privacyLaws);
      console.log('[COOKIE_COMPLIANCE] Requires consent:', requiresConsent);
      
      if (requiresConsent) {
        const applicableLaws = Object.entries(privacyLaws)
          .filter(([_, applies]) => applies)
          .map(([law, _]) => law.toUpperCase())
          .join(', ');
        console.log(`[COOKIE_COMPLIANCE] Privacy laws detected (${applicableLaws}), showing cookie banner`);
        setTimeout(showBanner, 2000);
      } else {
        console.log('[COOKIE_COMPLIANCE] No privacy laws detected for this region, enabling analytics by default');
        handleCookieConsent({
          essential: true,
          analytics: true,
          personalization: true
        });
      }
    } catch (error) {
      console.error('[COOKIE_COMPLIANCE] Error checking compliance requirements:', error);
      // If there's any error, show the banner as a fallback (better safe than sorry)
      setTimeout(showBanner, 3000);
    }
  }

  document.addEventListener('DOMContentLoaded', () => {
    const banner = document.getElementById('cookie-banner');
    const acceptButton = document.getElementById('accept-cookies');
    const saveButton = document.getElementById('save-preferences');
    const rejectButton = document.getElementById('reject-cookies');
    const closeButton = document.getElementById('close-cookie-banner');
    const analytics = document.getElementById('analytics-cookies') as HTMLInputElement;
    const personalization = document.getElementById('personalization-cookies') as HTMLInputElement;
    const analyticsLabel = document.querySelector('label[for="analytics-cookies"]');
    const personalizationLabel = document.querySelector('label[for="personalization-cookies"]');

    // Handle keyboard events for banner
    banner?.addEventListener('keydown', (e: KeyboardEvent) => {
      if (e.key === 'Escape') {
        hideBanner();
      }
    });

    // Add keyboard support for labels
    analyticsLabel?.addEventListener('keydown', (e: KeyboardEvent) => {
      if (e.key === 'Enter' || e.key === ' ') {
        e.preventDefault();
        if (analytics) {
          analytics.checked = !analytics.checked;
          analytics.focus();
        }
      }
    });

    personalizationLabel?.addEventListener('keydown', (e: KeyboardEvent) => {
      if (e.key === 'Enter' || e.key === ' ') {
        e.preventDefault();
        if (personalization) {
          personalization.checked = !personalization.checked;
          personalization.focus();
        }
      }
    });

    // Make labels focusable
    if (analyticsLabel) {
      analyticsLabel.setAttribute('tabindex', '0');
      analyticsLabel.setAttribute('role', 'button');
    }
    
    if (personalizationLabel) {
      personalizationLabel.setAttribute('tabindex', '0');
      personalizationLabel.setAttribute('role', 'button');
    }

    // Add keyboard support for checkboxes
    analytics?.addEventListener('keydown', (e: KeyboardEvent) => {
      if (e.key === 'Enter' || e.key === ' ') {
        e.preventDefault();
        analytics.checked = !analytics.checked;
      }
    });

    personalization?.addEventListener('keydown', (e: KeyboardEvent) => {
      if (e.key === 'Enter' || e.key === ' ') {
        e.preventDefault();
        personalization.checked = !personalization.checked;
      }
    });

    // Ensure checkboxes are unchecked by default
    if (analytics) analytics.checked = false;
    if (personalization) personalization.checked = false;

    // Add event listener for cookie changes
    window.addEventListener('cookiePreferencesChanged', ((event: CustomEvent) => {
      const { preferences, consentLevel } = event.detail;
      
      // Update UI elements based on preferences
      if (consentLevel === 'none') {
        // Disable all non-essential features and uncheck boxes
        document.querySelectorAll('[data-requires-consent]').forEach(el => {
          el.setAttribute('disabled', 'true');
        });
        if (analytics) analytics.checked = false;
        if (personalization) personalization.checked = false;
      } else {
        // Enable features based on specific preferences
        document.querySelectorAll('[data-requires-analytics]').forEach(el => {
          if (preferences.analytics) {
            el.removeAttribute('disabled');
          } else {
            el.setAttribute('disabled', 'true');
          }
        });
        
        document.querySelectorAll('[data-requires-personalization]').forEach(el => {
          if (preferences.personalization) {
            el.removeAttribute('disabled');
          } else {
            el.setAttribute('disabled', 'true');
          }
        });
      }
    }) as EventListener);
    
    // Initial check for existing preferences
    const savedPreferences = getCookie('cookie-preferences');
    if (savedPreferences) {
      const preferences = JSON.parse(savedPreferences);
      
      // Only set checked if explicitly true in saved preferences
      if (analytics) analytics.checked = preferences.analytics === true;
      if (personalization) personalization.checked = preferences.personalization === true;
      
      // Load Google Analytics and Sentry if previously consented
      if (preferences.analytics === true) {
        loadGoogleAnalytics();
        loadSentry();
      }
      
      // Trigger the event with existing preferences
      window.dispatchEvent(new CustomEvent('cookiePreferencesChanged', { 
        detail: { 
          preferences,
          consentLevel: getCookie('cookie-consent') || 'none'
        } 
      }));
    } else {
      // For new visitors, check geolocation for compliance requirements
      checkComplianceRequirements();
    }

    acceptButton?.addEventListener('click', () => {
      handleCookieConsent({
        essential: true,
        analytics: true,
        personalization: true
      });
    });

    saveButton?.addEventListener('click', () => {
      handleCookieConsent(getCurrentPreferences());
    });

    rejectButton?.addEventListener('click', () => {
      handleCookieConsent({
        essential: true,
        analytics: false,
        personalization: false
      });
    });

    closeButton?.addEventListener('click', hideBanner);

    // Update tooltips based on checkbox state
    function updateTooltip(checkbox: HTMLInputElement, tooltipId: string, cookieType: string) {
      const tooltip = document.getElementById(tooltipId);
      if (tooltip) {
        tooltip.textContent = checkbox.checked ? 
          `Disable ${cookieType} cookies` : 
          `Enable ${cookieType} cookies`;
      }
    }

    // Initial tooltip setup
    if (analytics) {
      updateTooltip(analytics, 'analytics-tooltip', 'Analytics');
      analytics.addEventListener('change', () => {
        updateTooltip(analytics, 'analytics-tooltip', 'Analytics');
      });
    }

    if (personalization) {
      updateTooltip(personalization, 'personalization-tooltip', 'Personalization');
      personalization.addEventListener('change', () => {
        updateTooltip(personalization, 'personalization-tooltip', 'Personalization');
      });
    }

    // Update tooltips when preferences change
    window.addEventListener('cookiePreferencesChanged', (event: CustomEvent) => {
      const { preferences } = event.detail;
      
      if (analytics) {
        analytics.checked = preferences.analytics === true;
        updateTooltip(analytics, 'analytics-tooltip', 'Analytics');
      }
      
      if (personalization) {
        personalization.checked = preferences.personalization === true;
        updateTooltip(personalization, 'personalization-tooltip', 'Personalization');
      }
    });
  });
</script>
