---
/**
 * Privacy-Compliant Cookie Consent Banner
 * Simplified, clean design
 */
---

<!-- Backdrop for expanded view -->
<div 
  id="cookie-banner-backdrop"
  class="cookie-backdrop"
  aria-hidden="true"
></div>

<!-- Main Cookie Banner -->
<div 
  id="cookie-banner" 
  class="cookie-banner"
  role="dialog"
  aria-labelledby="cookie-title"
  tabindex="-1"
>
  <!-- Compact View -->
  <div id="cookie-compact" class="cookie-compact">
    <div class="cookie-compact-content">
      <p class="cookie-text">
        We use cookies to improve your experience. We don't sell your data.
        <a href="/legal/privacy" class="cookie-link">Privacy Policy</a>
      </p>
      <div class="cookie-actions">
        <button id="show-cookie-settings" class="cookie-btn-text">Settings</button>
        <button id="reject-cookies-compact" class="cookie-btn-outline">Decline</button>
        <button id="accept-cookies-compact" class="cookie-btn-primary">Accept</button>
      </div>
    </div>
  </div>

  <!-- Expanded Settings -->
  <div id="cookie-expanded" class="cookie-expanded">
    <div class="cookie-panel">
      <div class="cookie-panel-header">
        <h3 id="cookie-title">Privacy Settings</h3>
        <button id="close-cookie-settings" class="cookie-close" aria-label="Close">
          <svg width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
      </div>

      <!-- GPC Notice -->
      <div id="gpc-notice" class="cookie-gpc" style="display: none;">
        <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
        </svg>
        <span>Global Privacy Control detected â€” you're opted out</span>
      </div>

      <div class="cookie-options">
        <label class="cookie-option disabled">
          <div class="cookie-option-text">
            <span class="cookie-option-name">Essential</span>
            <span class="cookie-option-desc">Required for site functionality</span>
          </div>
          <input type="checkbox" id="essential-cookies" checked disabled />
          <span class="cookie-toggle"></span>
        </label>

        <label class="cookie-option">
          <div class="cookie-option-text">
            <span class="cookie-option-name">Analytics</span>
            <span class="cookie-option-desc">Anonymous usage data</span>
          </div>
          <input type="checkbox" id="analytics-cookies" />
          <span class="cookie-toggle"></span>
        </label>

        <label class="cookie-option">
          <div class="cookie-option-text">
            <span class="cookie-option-name">Preferences</span>
            <span class="cookie-option-desc">Remember your settings</span>
          </div>
          <input type="checkbox" id="personalization-cookies" />
          <span class="cookie-toggle"></span>
        </label>
      </div>

      <p class="cookie-note">
        We do not sell or share your personal information. 
        <a href="/legal/privacy" class="cookie-link">Learn more</a>
      </p>

      <div class="cookie-panel-footer">
        <button id="reject-cookies" class="cookie-btn-outline">Decline All</button>
        <button id="save-preferences" class="cookie-btn-outline">Save</button>
        <button id="accept-cookies" class="cookie-btn-primary">Accept All</button>
      </div>
    </div>
  </div>
</div>

<style>
  .cookie-backdrop {
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.3);
    z-index: 9998;
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.2s, visibility 0.2s;
  }
  .cookie-backdrop.visible { opacity: 1; visibility: visible; }

  .cookie-banner {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    z-index: 9999;
    font-family: system-ui, -apple-system, sans-serif;
    transform: translateY(100%);
    transition: transform 0.25s ease;
  }
  .cookie-banner.visible { transform: translateY(0); }

  /* Compact bar */
  .cookie-compact {
    background: #fff;
    border-top: 1px solid #e5e7eb;
    box-shadow: 0 -2px 10px rgba(0,0,0,0.06);
  }
  .cookie-compact-content {
    max-width: 1200px;
    margin: 0 auto;
    padding: 0.75rem 1.25rem;
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 1rem;
  }
  .cookie-text {
    margin: 0;
    font-size: 0.8125rem;
    color: #6b7280;
  }
  .cookie-actions {
    display: flex;
    gap: 0.5rem;
    flex-shrink: 0;
  }

  /* Expanded panel */
  .cookie-expanded {
    display: none;
    background: #fff;
    border-top: 1px solid #e5e7eb;
    box-shadow: 0 -4px 20px rgba(0,0,0,0.1);
  }
  .cookie-expanded.visible { display: block; }
  
  /* Hide compact when expanded is visible */
  .cookie-compact.hidden { display: none; }

  .cookie-panel {
    max-width: 420px;
    margin: 0 auto;
    padding: 1.25rem;
  }
  .cookie-panel-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
  }
  .cookie-panel-header h3 {
    margin: 0;
    font-size: 1rem;
    font-weight: 600;
    color: #111;
  }
  .cookie-close {
    padding: 0.25rem;
    background: none;
    border: none;
    color: #9ca3af;
    cursor: pointer;
    border-radius: 4px;
  }
  .cookie-close:hover { color: #6b7280; background: #f3f4f6; }

  /* GPC notice */
  .cookie-gpc {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 0.75rem;
    background: #ecfdf5;
    border-radius: 6px;
    margin-bottom: 1rem;
    font-size: 0.75rem;
    color: #065f46;
  }
  .cookie-gpc svg { color: #10b981; flex-shrink: 0; }

  /* Options */
  .cookie-options {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
    margin-bottom: 0.75rem;
  }
  .cookie-option {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0.625rem 0.75rem;
    background: #f9fafb;
    border-radius: 6px;
    cursor: pointer;
    transition: background 0.15s;
  }
  .cookie-option:hover:not(.disabled) { background: #f3f4f6; }
  .cookie-option.disabled { opacity: 0.6; cursor: default; }
  .cookie-option input { display: none; }
  .cookie-option-text {
    display: flex;
    flex-direction: column;
    gap: 0.125rem;
  }
  .cookie-option-name {
    font-size: 0.8125rem;
    font-weight: 500;
    color: #111;
  }
  .cookie-option-desc {
    font-size: 0.6875rem;
    color: #9ca3af;
  }

  /* Toggle */
  .cookie-toggle {
    width: 36px;
    height: 20px;
    background: #d1d5db;
    border-radius: 10px;
    position: relative;
    transition: background 0.2s;
    flex-shrink: 0;
  }
  .cookie-toggle::after {
    content: '';
    position: absolute;
    top: 2px;
    left: 2px;
    width: 16px;
    height: 16px;
    background: #fff;
    border-radius: 50%;
    transition: transform 0.2s;
    box-shadow: 0 1px 2px rgba(0,0,0,0.1);
  }
  .cookie-option input:checked + .cookie-toggle {
    background: #111;
  }
  .cookie-option input:checked + .cookie-toggle::after {
    transform: translateX(16px);
  }
  .cookie-option.disabled .cookie-toggle {
    background: #9ca3af;
  }

  /* Note */
  .cookie-note {
    margin: 0 0 1rem;
    font-size: 0.6875rem;
    color: #9ca3af;
    text-align: center;
  }

  /* Footer */
  .cookie-panel-footer {
    display: flex;
    gap: 0.5rem;
  }
  .cookie-panel-footer button { flex: 1; }

  /* Buttons */
  .cookie-btn-primary {
    padding: 0.5rem 1rem;
    font-size: 0.8125rem;
    font-weight: 500;
    color: #fff;
    background: #111;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    transition: background 0.15s;
  }
  .cookie-btn-primary:hover { background: #333; }

  .cookie-btn-outline {
    padding: 0.5rem 1rem;
    font-size: 0.8125rem;
    font-weight: 500;
    color: #374151;
    background: #fff;
    border: 1px solid #e5e7eb;
    border-radius: 6px;
    cursor: pointer;
    transition: background 0.15s, border-color 0.15s;
  }
  .cookie-btn-outline:hover { background: #f9fafb; border-color: #d1d5db; }

  .cookie-btn-text {
    padding: 0.5rem 0.75rem;
    font-size: 0.8125rem;
    color: #6b7280;
    background: none;
    border: none;
    cursor: pointer;
  }
  .cookie-btn-text:hover { color: #374151; }

  /* Links */
  .cookie-link {
    color: #8B5A2B;
    text-decoration: underline;
    text-underline-offset: 2px;
  }
  .cookie-link:hover { color: #6B4423; }

  /* Responsive */
  @media (max-width: 640px) {
    .cookie-compact-content {
      flex-direction: column;
      text-align: center;
      gap: 0.75rem;
    }
    .cookie-actions { width: 100%; justify-content: center; }
    .cookie-panel { padding: 1rem; }
    .cookie-panel-footer { flex-direction: column; }
  }
</style>

<script>
  declare global {
    interface Window {
      showCookieSettings: () => void;
      dataLayer: any[];
      gtag: (...args: any[]) => void;
      Sentry: any;
    }
    interface Navigator { globalPrivacyControl?: boolean; }
  }

  interface CookiePreferences {
    essential: boolean;
    analytics: boolean;
    personalization: boolean;
  }

  const banner = document.getElementById('cookie-banner');
  const backdrop = document.getElementById('cookie-banner-backdrop');
  const expanded = document.getElementById('cookie-expanded');
  const compact = document.getElementById('cookie-compact');
  const gpcNotice = document.getElementById('gpc-notice');

  const hasGPC = () => navigator.globalPrivacyControl === true;
  const showBanner = () => banner?.classList.add('visible');
  const hideBanner = () => {
    banner?.classList.remove('visible');
    backdrop?.classList.remove('visible');
    expanded?.classList.remove('visible');
    compact?.classList.remove('hidden');
  };
  const showExpanded = () => {
    expanded?.classList.add('visible');
    backdrop?.classList.add('visible');
    compact?.classList.add('hidden');
  };
  const hideExpanded = () => {
    expanded?.classList.remove('visible');
    backdrop?.classList.remove('visible');
    compact?.classList.remove('hidden');
  };

  window.showCookieSettings = () => { showBanner(); showExpanded(); };

  function getCookie(name: string) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop()?.split(';').shift();
    return null;
  }

  function loadAnalytics() {
    if (!document.querySelector('script[src*="googletagmanager"]')) {
      const script = document.createElement('script');
      script.async = true;
      script.src = 'https://analytics.locc.us/ga/gtag/js?id=G-T4PD8XC0SC';
      document.head.appendChild(script);

      const config = document.createElement('script');
      config.textContent = `
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-T4PD8XC0SC', {
          'transport_url': 'https://analytics.locc.us/ga/g/collect',
          'anonymize_ip': true
        });
      `;
      document.head.appendChild(config);
    }
  }

  function unloadAnalytics() {
    document.querySelectorAll('script[src*="googletagmanager"]').forEach(s => s.remove());
    if (window.dataLayer) window.dataLayer = [];
  }

  function handleConsent(prefs: CookiePreferences) {
    const date = new Date();
    date.setTime(date.getTime() + 365 * 24 * 60 * 60 * 1000);
    document.cookie = `cookie-preferences=${JSON.stringify(prefs)};expires=${date.toUTCString()};path=/;SameSite=Strict`;
    
    if (prefs.analytics) loadAnalytics();
    else unloadAnalytics();
    
    hideBanner();
  }

  function getPrefs(): CookiePreferences {
    const analytics = document.getElementById('analytics-cookies') as HTMLInputElement;
    const personalization = document.getElementById('personalization-cookies') as HTMLInputElement;
    return {
      essential: true,
      analytics: analytics?.checked || false,
      personalization: personalization?.checked || false
    };
  }

  async function checkCompliance() {
    if (hasGPC() && gpcNotice) gpcNotice.style.display = 'flex';
    
    try {
      const res = await fetch('https://geo.locc.us/where');
      if (!res.ok) { setTimeout(showBanner, 2000); return; }
      const data = await res.json();
      const needsConsent = data.gdpr || data.ccpa || data.cpa || data.lgpd || data.pipeda || hasGPC();
      
      if (needsConsent) setTimeout(showBanner, 1500);
      else handleConsent({ essential: true, analytics: true, personalization: true });
    } catch { setTimeout(showBanner, 2000); }
  }

  document.addEventListener('DOMContentLoaded', () => {
    const analytics = document.getElementById('analytics-cookies') as HTMLInputElement;
    const personalization = document.getElementById('personalization-cookies') as HTMLInputElement;

    if (hasGPC() && gpcNotice) gpcNotice.style.display = 'flex';

    document.getElementById('show-cookie-settings')?.addEventListener('click', showExpanded);
    document.getElementById('close-cookie-settings')?.addEventListener('click', hideExpanded);
    backdrop?.addEventListener('click', hideExpanded);

    const acceptAll = () => handleConsent({ essential: true, analytics: true, personalization: true });
    const rejectAll = () => handleConsent({ essential: true, analytics: false, personalization: false });

    document.getElementById('accept-cookies-compact')?.addEventListener('click', acceptAll);
    document.getElementById('accept-cookies')?.addEventListener('click', acceptAll);
    document.getElementById('reject-cookies-compact')?.addEventListener('click', rejectAll);
    document.getElementById('reject-cookies')?.addEventListener('click', rejectAll);
    document.getElementById('save-preferences')?.addEventListener('click', () => handleConsent(getPrefs()));

    banner?.addEventListener('keydown', (e: KeyboardEvent) => {
      if (e.key === 'Escape' && expanded?.classList.contains('visible')) hideExpanded();
    });

    const saved = getCookie('cookie-preferences');
    if (saved) {
      const prefs = JSON.parse(saved);
      if (analytics) analytics.checked = prefs.analytics === true;
      if (personalization) personalization.checked = prefs.personalization === true;
      if (prefs.analytics) loadAnalytics();
    } else {
      checkCompliance();
    }
  });
</script>
