---
// 
// File: LocationPermissionPrompt.astro
// Component: LocationPermissionPrompt
//
// Description:
// Displays a contextual modal overlay asking for user location permission.
// Manages display state using localStorage to ensure it appears only once
// per session until the user responds.
//
// Note: This component contains no Astro frontmatter logic; it is pure HTML/CSS/JS.
//
---

<div 
  id="location-permission-modal"
  class="fixed inset-0 bg-black/70 z-50 flex items-center justify-center p-6 hidden" 
  role="dialog" 
  aria-modal="true"
  style="font-family: 'Albert Sans', system-ui, sans-serif;"
>
  <div class="bg-white rounded-lg max-w-sm w-full p-6 animate-in" aria-live="polite">
    <h2 class="text-lg font-semibold text-gray-900 mb-2">Share your location?</h2>
    <p class="text-sm text-gray-600 leading-relaxed mb-6">
      We'd like to show you directions to our church and personalize your experience. Your location is never stored or shared.
    </p>
    
    <div class="flex gap-3">
      <button
        id="location-deny"
        class="flex-1 text-gray-600 hover:text-gray-900 text-sm font-medium py-2.5 rounded-lg transition-colors"
      >
        Not now
      </button>
      <button
        id="location-allow"
        class="flex-1 bg-black hover:bg-gray-800 text-white text-sm font-medium py-2.5 rounded-lg transition-colors"
      >
        Allow
      </button>
    </div>
  </div>
</div>

<style>
  /* Simple CSS animation for a smoother entry */
  .animate-in {
    animation: fadeIn 0.2s ease-out;
  }
  
  @keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
  }
</style>

<script>
  const modal = document.getElementById('location-permission-modal');
  const allowBtn = document.getElementById('location-allow');
  const denyBtn = document.getElementById('location-deny');
  
  // @group State Check
  const storedLocation = localStorage.getItem('user-location');
  const hasLocation = storedLocation || (localStorage.getItem('user-lat') && localStorage.getItem('user-lng'));
  const hasAsked = localStorage.getItem('location-permission-asked');
  const hasPermission = localStorage.getItem('location-permission-granted');
  
  // Show the modal if:
  // 1. We haven't asked this user before.
  // 2. We don't have stored permission/location data.
  // 3. The browser supports the Geolocation API.
  if (!hasAsked && !hasPermission && !hasLocation && 'geolocation' in navigator) {
    // Show after a small delay (1 second) to allow main page content to load first.
    setTimeout(() => {
      modal?.classList.remove('hidden');
    }, 1000);
  }
  
  // @group Event Listeners
  
  // 1. ALLOW Button Click Handler
  allowBtn?.addEventListener('click', () => {
    // Hide the custom modal before triggering the native browser prompt
    modal?.classList.add('hidden');

    // Trigger browser's native location prompt (required user gesture)
    navigator.geolocation.getCurrentPosition(
      (position) => {
        // Success: User granted permission in the native prompt
        const lat = position.coords.latitude;
        const lng = position.coords.longitude;
        
        // Persist permissions and data in localStorage
        localStorage.setItem('location-permission-asked', 'true');
        localStorage.setItem('location-permission-granted', 'true');
        localStorage.setItem('user-lat', lat.toString());
        localStorage.setItem('user-lng', lng.toString());
        
        // Save combined JSON data for other components/systems to read
        const locationData = {
          lng: lng,
          lat: lat,
          source: 'browser',
          timestamp: Date.now()
        };
        localStorage.setItem('user-location', JSON.stringify(locationData));
        localStorage.setItem('user-location-time', Date.now().toString());
        
        // Reload page to initiate location-based features (e.g., dynamic map centers)
        window.location.reload();
      },
      () => {
        // Failure/Denial: User clicked 'Block' in the native browser prompt
        localStorage.setItem('location-permission-asked', 'true');
        localStorage.setItem('location-permission-granted', 'false');
      }
    );
  });
  
  // 2. DENY Button Click Handler
  denyBtn?.addEventListener('click', () => {
    modal?.classList.add('hidden');
    // Set 'asked' to true, but 'granted' to false, preventing modal from showing again
    localStorage.setItem('location-permission-asked', 'true');
    localStorage.setItem('location-permission-granted', 'false');
  });
  
  // 3. Close on backdrop click (treats as denial/dismissal)
  modal?.addEventListener('click', (e) => {
    if (e.target === modal) {
      modal.classList.add('hidden');
      localStorage.setItem('location-permission-asked', 'true');
      localStorage.setItem('location-permission-granted', 'false');
    }
  });
</script>