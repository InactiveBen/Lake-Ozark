---
// 
// File: SundayCalendar.astro
// Component: SundayCalendar
//
// Description:
// Renders a dynamic schedule for upcoming Sunday services. It attempts to fetch
// event data from a custom API and uses a pure JavaScript fallback to display
// a generic list of the next 8 Sundays if the API fails or returns no events.
//
// Dependencies:
// Relies on an external API endpoint: 'https://calander.locc.us/events'.
// Assumes utility classes (e.g., from Tailwind CSS) are available.
//
export interface Props {
  title?: string;
  subtitle?: string;
  maxEvents?: number;
  hideWhenNoData?: boolean;
}

const {
  title = "Upcoming Sunday Services",
  subtitle = "Join us for worship every Sunday at 10:30 AM",
  maxEvents = 6,
  hideWhenNoData = true
} = Astro.props;
---

<section class="py-20 bg-white">
  <div class="container mx-auto px-6">
    <div class="max-w-7xl mx-auto">
      <div class="text-center mb-16">
        <span class="inline-block px-4 py-2 bg-brand/10 text-brand text-sm font-medium mb-4">
          Stay Connected
        </span>
        <h2 class="text-4xl lg:text-5xl font-light mb-6 text-gray-900">{title}</h2>
        <p class="text-lg text-gray-600 max-w-2xl mx-auto">
          {subtitle}
        </p>
      </div>
      
      <div id="calendar-loading" class="text-center py-16">
        <div class="inline-flex items-center gap-3">
          <div class="animate-spin rounded-full h-8 w-8 border-2 border-brand border-t-transparent" role="status"></div>
          <p class="text-lg text-gray-600">Loading upcoming services...</p>
        </div>
      </div>
      
      <div id="calendar-error" class="text-center py-16 hidden">
        <div class="bg-red-50 border border-red-200 p-8 max-w-md mx-auto rounded-xl" role="alert">
          <p class="text-red-700 font-medium">Unable to load calendar</p>
          <p class="text-red-600 text-sm mt-1">Please try again later</p>
        </div>
      </div>
      
      <div id="custom-calendar" class="hidden">
        <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-6" id="calendar-events">
          </div>
      </div>
      
      <div id="fallback-sundays" class="hidden">
        <div class="bg-gray-50 rounded-2xl p-8">
          <h3 class="text-2xl font-semibold mb-6 text-gray-900 text-center">Upcoming Sundays</h3>
          <div class="grid md:grid-cols-2 gap-4" id="sunday-list">
            </div>
        </div>
      </div>
    </div>
  </div>
</section>

<script define:vars={{ maxEvents, hideWhenNoData }}>
  // Pass Astro props to the client-side script for dynamic behavior
  
  /**
   * @function loadCustomCalendar
   * Primary function to fetch, process, and display calendar data from the API.
   * Handles loading, success, error, and fallback states.
   */
  async function loadCustomCalendar() {
    const loadingEl = document.getElementById('calendar-loading');
    const customCalendarEl = document.getElementById('custom-calendar');
    const section = document.querySelector('section');

    // Hide loading immediately if the section should be hidden upon failure/no data
    if (loadingEl) loadingEl.style.display = 'none';
    
    try {
      const apiUrl = 'https://calander.locc.us/events';
      
      const response = await fetch(apiUrl);
      if (!response.ok) {
        throw new Error(`API returned status ${response.status}`);
      }
      
      const data = await response.json();
      
      if (data.success && data.events && data.events.length > 0) {
        // Success: Display API events
        displayCustomEvents(data.events);
        if (customCalendarEl) customCalendarEl.classList.remove('hidden');
        return;
      }
      
      // Fallback: API returned no events or empty data
      if (hideWhenNoData) {
        // Hide entire component
        if (section) section.style.display = 'none';
      } else {
        // Show generic Sunday list
        showFallbackSundays();
      }
      
    } catch (error) {
      console.error('Error loading calendar:', error);
      
      // Error: Handle based on hideWhenNoData setting
      if (hideWhenNoData) {
        if (section) section.style.display = 'none';
      } else {
        showFallbackSundays();
        // Optional: Show the dedicated error message on top of the fallback
        document.getElementById('calendar-error')?.classList.remove('hidden');
      }
    }
  }
  
  /**
   * @function displayCustomEvents
   * Renders events fetched from the API into the custom grid.
   * Groups multiple events on the same day into one card.
   * @param {Array<Object>} events - Array of calendar events.
   */
  function displayCustomEvents(events) {
    const eventsContainer = document.getElementById('calendar-events');
    if (!eventsContainer) return;
    
    // Group events by date (Date key: "Sun Aug 31 2025")
    const eventsByDate = {};
    events.forEach(event => {
      // Use date or dateTime depending on which is available
      const eventDate = new Date(event.start.dateTime || event.start.date);
      const dateKey = eventDate.toDateString(); 
      
      if (eventDate.getDay() === 0) { // Only process Sundays (Day 0)
        if (!eventsByDate[dateKey]) {
          eventsByDate[dateKey] = {
            date: eventDate,
            events: []
          };
        }
        eventsByDate[dateKey].events.push(event);
      }
    });
    
    // Sort chronologically and limit to maxEvents
    const sortedDates = Object.values(eventsByDate).sort((a, b) => a.date.getTime() - b.date.getTime());
    
    const eventsHTML = sortedDates.slice(0, maxEvents).map(dateGroup => {
      const formattedDate = dateGroup.date.toLocaleDateString('en-US', {
        weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'
      });
      
      // Sort services within the day by time
      dateGroup.events.sort((a, b) => {
        const timeA = new Date(a.start.dateTime || a.start.date);
        const timeB = new Date(b.start.dateTime || b.start.date);
        return timeA.getTime() - timeB.getTime();
      });
      
      // Combine multiple service times into a single string (e.g., "9:00 AM & 10:30 AM")
      const timeStrings = dateGroup.events.map(event => {
        const eventDate = new Date(event.start.dateTime || event.start.date);
        return eventDate.toLocaleTimeString('en-US', { 
          hour: 'numeric', minute: '2-digit', hour12: true 
        });
      });
      
      const timesDisplay = timeStrings.join(' & ');
      
      return `
        <div class="bg-white border border-gray-200 rounded-xl p-6 hover:shadow-lg transition-all duration-300">
          <div class="flex items-start gap-4">
            <div class="w-12 h-12 bg-brand/10 rounded-full flex items-center justify-center flex-shrink-0">
              <svg class="w-6 h-6 text-brand" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
              </svg>
            </div>
            <div class="flex-1">
              <h3 class="font-semibold text-lg text-gray-900 mb-2">Sunday Service</h3>
              <p class="text-gray-600 text-sm mb-1">${formattedDate}</p>
              <p class="text-gray-500 text-sm">${timesDisplay}</p>
            </div>
          </div>
        </div>
      `;
    }).join('');
    
    eventsContainer.innerHTML = eventsHTML;
  }
  
  /**
   * @function showFallbackSundays
   * Renders a simple, generic list of the next 8 consecutive Sundays with a fixed time.
   * Used when API data is unavailable, but the component must still display.
   */
  function showFallbackSundays() {
    const fallbackEl = document.getElementById('fallback-sundays');
    const sundayListEl = document.getElementById('sunday-list');
    
    if (!sundayListEl) return;
    
    // Generate next 8 Sundays
    const sundays = [];
    const today = new Date();
    let currentDate = new Date(today);
    
    // Algorithm to find the *next* upcoming Sunday, handling today being Sunday or a later day
    const daysUntilSunday = (7 - currentDate.getDay()) % 7;
    currentDate.setDate(currentDate.getDate() + daysUntilSunday);
    
    // If today is Sunday, start from today. If not, currentDate is the next Sunday.
    if (today.getDay() !== 0) {
      currentDate.setDate(currentDate.getDate() + 7);
    }

    // Generate 8 future Sundays
    for (let i = 0; i < 8; i++) {
      const sundayDate = new Date(currentDate);
      sundayDate.setDate(currentDate.getDate() + (i * 7));
      
      sundays.push({
        date: sundayDate,
        formatted: sundayDate.toLocaleDateString('en-US', {
          weekday: 'long', month: 'long', day: 'numeric', year: 'numeric'
        })
      });
    }
    
    // Create HTML for the fallback list
    const sundaysHTML = sundays.map(sunday => `
      <div class="bg-white border border-gray-200 rounded-lg p-4 text-center">
        <div class="w-10 h-10 bg-brand/10 rounded-full flex items-center justify-center mx-auto mb-3">
          <svg class="w-5 h-5 text-brand" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
          </svg>
        </div>
        <h4 class="font-semibold text-gray-900 mb-1">Sunday Service</h4>
        <p class="text-sm text-gray-600">${sunday.formatted}</p>
        <p class="text-xs text-gray-500 mt-1">10:30 AM</p>
      </div>
    `).join('');
    
    sundayListEl.innerHTML = sundaysHTML;
    
    if (fallbackEl) fallbackEl.classList.remove('hidden');
  }
  
  // @group Initialization
  
  // Initialize calendar when standard DOMContentLoaded fires
  document.addEventListener('DOMContentLoaded', loadCustomCalendar);
  
  // Also initialize on Astro page load, crucial for View Transitions or client-side navigation
  document.addEventListener('astro:page-load', loadCustomCalendar);
</script>